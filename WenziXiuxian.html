<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>文字修仙：諸天宿命</title>
    <style>
        :root { --gold: #d4af37; --crimson: #b22222; --dark: #080808; --text: #e0e0e0; }
        body { background: var(--dark); color: var(--text); font-family: "Noto Serif TC", "Songti TC", serif; margin: 0; line-height: 2.2; overflow-x: hidden; }
        #app { max-width: 1000px; margin: 0 auto; padding: 20px 40px; }
        
        /* 數值欄 */
        .stats-bar { 
            background: rgba(10, 10, 10, 0.95); padding: 25px; border-bottom: 3px solid var(--gold); 
            display: flex; justify-content: space-between; color: var(--gold); font-weight: 700; 
            position: sticky; top: 0; z-index: 100; font-size: 20px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* 故事區 */
        .story-box { 
            font-size: 22px; background: #121212; padding: 60px; margin-top: 30px;
            border: 1px solid #333; border-left: 8px solid var(--crimson); 
            white-space: pre-wrap; text-align: justify; letter-spacing: 0.05em; 
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8); transition: all 0.5s ease;
        }
        .story-title { font-size: 32px; color: var(--crimson); margin-bottom: 30px; font-weight: bold; text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px; }

        /* 選項區 */
        .options { display: flex; flex-direction: column; gap: 25px; margin-top: 40px; }
        button { 
            background: linear-gradient(90deg, #1a1a1a, #252525); border: 1px solid #444; color: #ccc; 
            padding: 30px; font-size: 20px; text-align: left; cursor: pointer; transition: 0.3s; 
            position: relative; overflow: hidden; font-family: inherit;
        }
        button:hover { 
            border-color: var(--gold); color: var(--gold); transform: translateX(10px); 
            background: linear-gradient(90deg, #222, #000);
            box-shadow: -5px 0 20px rgba(178, 34, 34, 0.5); 
        }
        .btn-tag { font-size: 16px; color: var(--crimson); font-weight: bold; margin-bottom: 5px; display: block; }

        /* 結果與反饋 */
        .consequence { 
            font-size: 20px; color: var(--gold); background: #1a0505; padding: 40px; 
            border: 1px dashed var(--crimson); margin-top: 30px; display: none; 
            animation: fadeIn 0.5s; 
        }
        
        .next-btn { 
            width: 100%; text-align: center; background: var(--crimson); color: #fff; border: none; 
            padding: 30px; font-size: 24px; cursor: pointer; margin-top: 30px; display: none; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 5px;
            box-shadow: 0 0 20px var(--crimson);
        }
        .next-btn:hover { background: #d00000; scale: 1.02; }

        /* 輸入框 */
        input { 
            background: #000; border: 2px solid var(--gold); color: var(--gold); 
            padding: 20px; font-size: 28px; text-align: center; width: 60%; 
            outline: none; box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); 
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app">
    <div id="setup" style="text-align:center; padding-top: 100px;">
        <h1 style="color:var(--gold); font-size:100px; margin-bottom:20px; text-shadow: 0 0 50px var(--crimson);">文字修仙</h1>
        <p style="font-size: 24px; color: #888; margin-bottom: 60px;">大道無情，唯我獨尊</p>
        <div>
            <input type="text" id="playerName" placeholder="在此刻下汝之真名" maxlength="6"><br><br>
            <button onclick="startGame()" style="width:300px; text-align:center; display:inline-block; border: 2px solid var(--gold); background: #000;">開啟逆命之路</button>
        </div>
    </div>

    <div id="game" style="display:none;">
        <div class="stats-bar" id="statsBar">
            </div>
        <div id="storyContainer">
            <div id="storyContent" class="story-box"></div>
        </div>
        <div id="consequenceBox" class="consequence"></div>
        <div id="optionList" class="options"></div>
        <button id="nextBtn" class="next-btn" onclick="handleNext()">踏入下一重境界</button>
    </div>
</div>

<script>
/* 核心數據結構 
*/
const player = { 
    name: "", 
    path: "", // LONE, SCHOLAR, BEGGAR
    chapter: 1, 
    stats: { pwr: 0, bne: 0, cha: 0, lck: 0 }, 
    journal: [] // 用於生成最後的小說
};

/* 第一階段：1~4 章 劇情數據庫
   字數要求：每章描述極致細膩，充滿動作與氛圍
*/
const STORY_DB = {
    // === 孤狼線：北境復仇，體魄劍道 ===
    LONE: {
        1: {
            title: "第一章：北境雪 · 斷天遺恨",
            text: (n) => `北境的風雪如同無數把細碎的刀片，瘋狂地切割著這片被鮮血染紅的凍土。${n}跪在烏鴉村焦黑的廢墟中央，膝蓋下的積雪早已融化成血水。他的雙手死死攥著一塊漆黑如炭、表面坑窪不平的廢鐵——那是父親臨死前塞入他懷中的「斷天殘鐵」，也是燕家赤羽衛屠村的唯一理由。\n\n「交出來，留你全屍。」赤羽衛執事燕狂屠腳踏飛劍，懸浮在半空，居高臨下地俯視著${n}，眼神如同看著一隻待宰的羔羊。周圍是三十名手持勁弩的燕家精銳，冰冷的箭簇閃爍著令人絕望的寒光。不遠處，老村長的頭顱被掛在枯樹上，雙目圓睜，死不瞑目。\n\n${n}的身體因為極度的憤怒而劇烈顫抖，指甲深深嵌入掌心，鮮血滴落在殘鐵之上。剎那間，那塊廢鐵發出了一聲淒厲的劍鳴，彷彿來自太古的凶獸甦醒！識海深處，劍靈霜兒的聲音帶著無盡的戾氣響起：「${n}，看看這世道！弱者連呼吸都是錯！你若不想死，便將你的血、你的肉、你的靈魂全部獻祭給我！我帶你殺出一條血路！」`,
            opts: [
                { t: "【暴戾血祭】以凡人之軀，獻祭精血，強行催動殘鐵殺人！", r: "你發出一聲非人的咆哮，全身血管爆裂，鮮血被殘鐵貪婪吞噬。一道暗金色的劍氣橫掃而出，將空中的燕狂屠連人帶劍劈成兩半！溫熱的臟器灑落在你臉上，你卻感到前所未有的快意。", s: {pwr: 5000, bne: 2000}, log: (n) => `${n}於烏鴉村絕境中血祭斷天殘鐵，以凡人之軀逆斬築基修士，殺意震動北境。` },
                { t: "【極致冷靜】利用風雪死角，奪取燕家火雷彈引爆。", r: "你強壓下滔天怒火，在箭雨落下前滾入廢墟死角，引爆了燕家堆放的火雷。巨大的爆炸引發了雪崩，將赤羽衛盡數掩埋，你如幽靈般消失在風雪中。", s: {lck: 5000, bne: 3000}, log: (n) => `${n}面對屠村之恨保持絕對理智，引發雪崩坑殺強敵，展現出令人膽寒的戰術素養。` },
                { t: "【瘋魔吞噬】不顧爆體風險，將殘鐵生生吞入腹中。", r: "你瘋了！你直接張口咬住那塊滾燙的殘鐵，魔性的金屬液體順著喉嚨灼燒內臟。你的皮膚開始龜裂，長出黑色的劍鱗，一股毀滅性的力量在體內炸開。", s: {cha: 6000, pwr: 3000}, log: (n) => `${n}行極端之事，生吞神鐵，在死亡邊緣鑄就不滅魔劍之體，從此非人非鬼。` }
            ]
        },
        2: {
            title: "第二章：冰川煉獄 · 肉身成聖",
            text: (n) => `大雪封山已經三個月。${n}躲藏在極北之地的萬年冰裂隙中，這裡的寒氣足以瞬間凍裂鋼鐵，但他卻赤裸著上身，任由冰棱劃破皮膚。每一次呼吸，肺部都傳來撕裂般的劇痛，但隨著斷天劍氣在經脈中遊走，那些傷口又以肉眼可見的速度癒合，新生的肌膚泛著金屬般的光澤。\n\n「找到了！他在下面！」頭頂傳來燕家搜山隊的呼喝聲。緊接著，無數道火球符咒如同流星雨般砸落，將冰裂隙炸得粉碎。${n}緩緩睜開眼，他的瞳孔已經完全變成了豎立的金色獸瞳。他沒有逃，反而露出了一絲猙獰的笑容。這三個月的折磨，早已將他鍛造成了一件人形兵器。他猛地一拳轟向頭頂墜落的巨冰，恐怖的肉身力量竟然打出了音爆，碎冰如散彈般倒飛回去，穿透了數名修士的胸膛。\n\n「既然你們急著送死，」${n}從冰霧中走出，浑身蒸腾着白气，「那我就用這雙手，把你們一個個撕碎。」`,
            opts: [
                { t: "【霸道橫推】無視法術轟炸，靠肉身硬撞入敵群！", r: "你如同一頭蠻荒兇獸，任由火球在身上炸開，一步未退。你抓住一名修士的頭顱，將其捏碎。這種純粹的暴力讓剩餘的敵人肝膽俱裂。", s: {pwr: 8000, bne: 3000}, log: (n) => `${n}於極北冰原展現恐怖肉身，無視術法，徒手撕裂燕家搜山隊，凶名赫赫。` },
                { t: "【劍氣佈局】引導地脈寒氣，瞬間凍結方圓百里。", r: "你將體內的劍氣打入冰川地脈，引發連鎖反應。白色的寒潮瞬間吞沒了搜山隊，百名修士在剎那間化為栩栩如生的冰雕。", s: {bne: 8000, lck: 4000}, log: (n) => `${n}借天地之威，一念之間凍結百里，以智慧與根骨坑殺強敵。` },
                { t: "【嗜血魔性】抓住敵人直接吸食精血，以戰養戰。", r: "你化作一道黑色的閃電，每經過一人便留下一具乾屍。滾燙的鮮血滋潤了你乾涸的經脈，你的混沌氣息愈發濃烈，宛如魔主降世。", s: {cha: 10000, pwr: 4000}, log: (n) => `${n}在戰鬥中覺醒嗜血本能，以敵人之血淬煉魔軀，手段殘忍至極。` }
            ]
        },
        3: {
            title: "第三章：獨闖萬劍 · 血洗世家",
            text: (n) => `萬劍城，燕家的大本營，今日張燈結彩。燕家老祖正欲將那把名為「赤霄」的偽仙劍傳給少主，全城的修士都在高呼燕家萬歲。然而，一個身披殘破斗篷的身影，正拖著一把生鏽的斷劍，一步步走向城門。每一步落下，大地便是一次震顫。\n\n${n}站在城門下，抬頭看著那高聳入雲的城牆和護城大陣，眼中沒有絲毫波瀾。他緩緩舉起右手，體內的斷天劍意瘋狂壓縮、凝聚，直到周圍的空間都開始扭曲。「燕家，欠債還錢，欠命……還命！」\n\n一聲長嘯，${n}手中的斷劍斬出。這一劍沒有花俏的變化，只有極致的重、極致的快！「轟隆！」號稱防禦無敵的護城大陣像蛋殼一樣碎裂，巨大的衝擊波將城門樓連同上面的數百守衛直接抹去。煙塵散去，${n}踏著廢墟入城，身後是一條筆直的血路。`,
            opts: [
                { t: "【滅門絕戶】殺盡燕家嫡系，雞犬不留！", r: "你殺紅了眼，燕家嫡系三百口無一倖免。赤霄劍被你單手折斷，燕家老祖被你釘死在祖祠之上。你的殺伐之道徹底圓滿。", s: {pwr: 12000, bne: 5000}, log: (n) => `${n}單人破城，血洗萬劍城燕家，折斷赤霄，將其百年基業付之一炬。` },
                { t: "【掠奪靈脈】使用禁術，強行抽取全城靈脈。", r: "你將斷劍插入城市中心，巨大的漩渦吸乾了萬劍城的氣運與靈氣。整座城市轟然塌陷，你卻獲得了堪比化神期的底蘊。", s: {lck: 15000, cha: 8000}, log: (n) => `${n}行逆天之舉，抽乾萬劍城靈脈，以一城氣運成就己身霸業。` },
                { t: "【公開審判】將燕家勾結妖族的罪證公諸於世。", r: "你在廢墟之上高聲宣讀罪狀，引發全城散修倒戈。你在歡呼聲中斬下老祖頭顱，獲得了海量的信仰之力與功德。", s: {bne: 10000, lck: 12000}, log: (n) => `${n}不僅誅身更是誅心，揭露燕家罪行，攜大義滅之，名動天下。` }
            ]
        },
        4: {
            title: "第四章：聖女降臨 · 歸墟門開",
            text: (n) => `萬劍城的毀滅引發了天道感應。蒼穹裂開一道巨大的紫色縫隙，那便是傳說中的「歸墟」。一名身披星光霓裳、腳踏青蓮的女子從裂縫中緩緩飄落。她美得不可方物，卻冷得讓人心悸——天道聖女，蘇清月。\n\n「凡人，你殺戮過重，亂了因果，當誅。」蘇清月的聲音清脆悅耳，卻帶著不容置疑的判決。她甚至沒有正眼看${n}，只是隨手揮出一道銀色的法則鎖鏈，便將${n}死死禁錮在原地。那是一種維度上的碾壓，凡人的力量在法則面前顯得如此蒼白。\n\n「亂了因果？」${n}渾身骨骼被壓得咯咯作響，七竅流血，但他卻昂起頭，臉上露出瘋狂的笑意，「燕家屠村時你在哪？現在我復仇了，你卻來談因果？去你媽的天道！」\n\n伴隨著一聲怒吼，${n}體內的斷天劍意燃燒了生命本源，竟硬生生將銀色鎖鏈崩出了一道裂痕！蘇清月眼中閃過一絲詫異，隨即是更深的殺機。她玉手一翻，將${n}打入了身後的歸墟裂縫之中：「既然你想死，那便去歸墟化為塵埃吧。」`,
            opts: [
                { t: "【不屈狂徒】臨走前向聖女吐一口血痰，誓言必殺！", r: "你的鮮血沾染了聖女的霓裳，這是她萬年來受到的最大羞辱。你帶著狂笑墜入歸墟，這股不屈的意志讓你的神魂堅不可摧。", s: {pwr: 20000}, log: (n) => `${n}面對天道聖女寧折不彎，以血汙其聖潔，狂笑著墜入歸墟，誓要逆天。` },
                { t: "【竊取天機】在鎖鏈崩斷瞬間，偷學聖女的一絲法則。", r: "你利用身體接觸的瞬間，解析了法則鎖鏈的構造。雖然身受重傷，但你掌握了一絲「縛神」法則的皮毛，根骨暴增。", s: {bne: 15000, lck: 5000}, log: (n) => `${n}於必死之局中膽大包天，竊取聖女一絲法則感悟，帶著天大機緣入歸墟。` },
                { t: "【主動投身】藉助聖女掌力，加速衝入歸墟深處。", r: "你順勢而為，像一顆炮彈般衝入歸墟，藉助這股推力擺脫了空間亂流的絞殺。這份算計讓你在起跑線上贏了一步。", s: {lck: 20000, cha: 5000}, log: (n) => `${n}借力打力，利用聖女攻擊加速遁入歸墟深處，其心機深不可測。` }
            ]
        }
    },

    // === 寒門線：江南權謀，因果算計 ===
    SCHOLAR: {
        1: {
            title: "第一章：江南血火 · 古卷覺醒",
            text: (n) => `江南沈府，世代書香門第。然而今夜，這裡卻成了人間煉獄。二皇子的影衛為了尋找傳說中的《乾坤古卷》，將沈府上下三百口封鎖在火海之中。${n}站在藏書閣的頂層，看著樓下恩師被影衛首領一刀斬下頭顱，鮮血濺在書架上，染紅了聖賢書。\n\n「百無一用是書生？呵……」${n}慘笑著，手中的一卷泛黃古籍突然無風自動。這是沈家守護千年的秘密，只有在極致的悲憤中才能開啟的神物。古卷展開，無數金色的文字如蝌蚪般飛出，在${n}的眼中構築成了一張巨大的因果網。他看見了影衛首領腳下的死線，看見了皇宮深處那條貪婪的氣運金龍。\n\n「既然這世道不講理，那我便用這天地為棋盤，與你們下一盤生死局！」${n}的手指在虛空中輕輕撥動，一根肉眼可見的因果線被他強行扭斷。`,
            opts: [
                { t: "【佈陣殺局】以沈府大火為陣，引影衛自相殘殺！", r: "你修改了火勢走向與光影折射，影衛們陷入幻覺，將同伴當作敵人瘋狂砍殺。你踏著他們的屍體走出火海，智謀通神。", s: {bne: 5000, lck: 3000}, log: (n) => `${n}於沈府大火中佈下奇門幻陣，令皇家影衛自相殘殺，兵不血刃走出絕地。` },
                { t: "【文字言靈】燃燒十年壽元，使用古卷「殺」字訣。", r: "你在虛空寫下一個血紅的「殺」字。字體崩碎，化作無數道無形的利刃，瞬間將周圍的敵人千刀萬剮。這是儒道的霸道。", s: {pwr: 4000, cha: 4000}, log: (n) => `${n}以儒道言靈之術，燃燒壽元寫下殺伐真言，展現了讀書人的雷霆之怒。` },
                { t: "【竊取龍氣】隔空抽取影衛身上的皇室氣運。", r: "你沒有直接殺人，而是利用古卷吸乾了他們身上的龍氣庇護。影衛們突然各種意外橫死（樑柱倒塌、心魔爆發）。你的福緣達到頂點。", s: {lck: 8000, bne: 2000}, log: (n) => `${n}利用因果律剝奪皇室氣運，令敵人死於天災人禍，手段詭譎難測。` }
            ]
        },
        2: {
            title: "第二章：水路逃亡 · 算盡機關",
            text: (n) => `逃出沈府後，${n}乘一葉扁舟順流而下，直奔京城。朝廷的海捕文書已發遍天下，沿途關卡重重。更可怕的是，二皇子派出了精通追蹤的「聽風閣」刺客。江面上，霧氣瀰漫，殺機四伏。\n\n${n}盤坐在船頭，手中的古卷懸浮，推演著每一步的生機。他知道，前方三里處的蘆葦蕩埋伏著三十張強弩，水下還有六名鑿船的水鬼。若是尋常修士，唯有力戰，但在${n}眼中，這一切都是可以利用的變數。\n\n「風向東南，水流湍急，正合我意。」${n}嘴角微揚，手指輕彈水面，一道細微的靈力波動傳出，驚擾了水底沉睡的一頭百年鱷龜。`,
            opts: [
                { t: "【借刀殺人】引誘鱷龜撞擊埋伏船隻。", r: "暴怒的鱷龜掀翻了刺客的戰船，水鬼在巨獸口中慘叫。你趁亂駕舟穿過封鎖，衣不沾水。", s: {bne: 6000, lck: 4000}, log: (n) => `${n}於江上談笑用兵，驅使百年妖獸破除朝廷埋伏，展現對萬物的精準掌控。` },
                { t: "【逆轉因果】強行修改弩箭的必中因果。", r: "當箭雨射來時，你撥動琴弦般的因果線。那些箭矢竟在空中詭異轉向，射死了埋伏者自己。這種手段如同鬼神。", s: {cha: 5000, lck: 6000}, log: (n) => `${n}操縱因果律，令漫天箭雨倒戈，視物理法則如無物，震驚追兵。` },
                { t: "【大霧迷蹤】佈置八卦迷魂陣，困死追兵。", r: "江面大霧突變濃稠，刺客們在方圓百米內打轉了三天三夜直至餓死。你從容離去，不帶走一片雲彩。", s: {bne: 8000}, log: (n) => `${n}布下奇門遁甲，將數十名頂尖刺客困死於江霧之中，智近乎妖。` }
            ]
        },
        3: {
            title: "第三章：京城對弈 · 隻手遮天",
            text: (n) => `京城，權力的漩渦中心。${n}化名入京，僅用一個月便成為了二皇子的座上賓——當然，二皇子並不知道這就是他要殺的人。${n}在皇子府中運籌帷幄，表面上為其出謀劃策，實則在暗中將皇子的羽翼一根根剪除。\n\n今日是二皇子逼宮奪位的日子。大殿之上，刀光劍影。二皇子得意洋洋地看著老皇帝，正欲宣讀退位詔書。${n}站在陰影中，手中的摺扇輕輕合上。「時辰到了，殿下，這出戲該落幕了。」\n\n隨著${n}的話音落下，二皇子驚恐地發現，原本支持他的禁軍統領突然倒戈，手中的詔書變成了認罪書，而他體內的修為竟然在莫名流失！一切都在${n}的計算之中。`,
            opts: [
                { t: "【氣運崩壞】徹底引爆二皇子的命格劫數。", r: "二皇子當場走火入魔，七竅流血而亡。你吸納了他潰散的皇氣，古卷進化為金色。你成為了幕後的無冕之王。", s: {lck: 12000, cha: 5000}, log: (n) => `${n}於金鑾殿上兵不血刃，引爆皇子氣運劫數，翻手為雲覆手為雨，顛覆皇權。` },
                { t: "【傀儡政權】扶持幼帝，自己在幕後攝政。", r: "你留了二皇子一命，將其製成傀儡。整個王朝的資源任你調用，根骨與靈慧獲得舉國之力的加持。", s: {bne: 15000, pwr: 2000}, log: (n) => `${n}將皇權玩弄於股掌，以天下資源供養己身，成就人間帝師之位。` },
                { t: "【儒聖顯聖】當眾顯露真身，以文章鎮壓百官。", r: "你一步踏出，浩然正氣衝破大殿穹頂。百官跪伏，你以文入道，直接跨過築基，踏入結丹境。", s: {pwr: 8000, bne: 10000}, log: (n) => `${n}顯露儒聖法相，以浩然正氣鎮壓朝堂，不屑陰謀，堂堂正正碾壓眾生。` }
            ]
        },
        4: {
            title: "第四章：天道不容 · 算計蒼天",
            text: (n) => `就在${n}掌控人間皇權巔峰之時，天空中裂開了一道紫色的縫隙。聖女蘇清月帶著天道的意志降臨皇城。她看著下方那個算無遺策的書生，眉頭微皺：「凡人，你妄動皇朝氣運，擾亂人間秩序，已犯天條。」\n\n無數道銀色的法則鎖鏈從天而降，無視了皇城的防禦大陣，直接鎖定了${n}的靈魂。這不是凡間的力量，這是維度打擊。\n\n${n}沒有驚慌，反而露出了一絲詭計得逞的微笑。他手中的古卷飛速翻動，無數因果線沖天而起，竟然主動纏繞上了那些法則鎖鏈。「等你很久了，蘇清月。若不引你出來，我如何算計這天？」\n\n原來，顛覆皇權只是誘餌，${n}真正的目標是捕獲「天道」的樣本！`,
            opts: [
                { t: "【以身為餌】讓鎖鏈鎖住肉身，反向侵蝕天道。", r: "你任由鎖鏈穿骨，卻將自己的因果病毒注入天道網絡。蘇清月臉色大變，被迫將你打入歸墟以切斷連接。你帶著天道數據狂笑而去。", s: {bne: 20000}, log: (n) => `${n}以自身為病毒，反向侵蝕天道法則，逼得聖女斷臂求生，算計之深令神佛汗顏。` },
                { t: "【瞞天過海】用替身人偶承受一擊，真身潛入歸墟。", r: "蘇清月抓走的只是一個稻草人，而你的真身早已藉助空間波動，主動跳入歸墟尋找更大的機緣。福緣爆表。", s: {lck: 20000, cha: 5000}, log: (n) => `${n}在聖女眼皮底下施展瞞天過海，肉身成謎，主動踏入歸墟佈局未來。` },
                { t: "【正面論道】用言語動搖聖女的道心。", r: "你大喝三聲「天道不公」，引發天地共鳴。蘇清月道心微顫，那一瞬間的遲疑讓你奪走了一縷聖氣。雖然被打入歸墟，但你贏了半子。", s: {cha: 10000, bne: 10000}, log: (n) => `${n}與聖女論道，動搖其堅固道心，於精神層面勝過天道一籌，瀟灑離去。` }
            ]
        }
    },

    // === 蟻民線：熔爐吞噬，混沌魔道 ===
    BEGGAR: {
        1: {
            title: "第一章：萬劫熔爐 · 人肉丹藥",
            text: (n) => `京城地底，這裡有一座巨大的青銅熔爐——「萬劫爐」。爐內燃燒著幽綠色的鬼火，數千名像${n}這樣的乞丐、流民被當作「藥引」扔在這裡。太子為了煉製長生不老丹，視人命如草芥。\n\n四周充滿了淒厲的慘叫和烤肉的焦臭味。${n}縮在角落裡，看著身邊的人一個個倒下，化為血水。極度的飢餓和恐懼讓他幾近崩潰。突然，一顆漆黑的珠子隨著血水流到了他的手邊——那是上古魔尊遺留的「永生魔種」。\n\n一個充滿誘惑的聲音在他腦海中響起：「想活嗎？那就吃。吃掉這珠子，吃掉這周圍的一切。在這個世界，不吃人，就會被人吃！」${n}看著那逼近的鬼火，眼中閃過一絲狠戾，抓起魔種吞了下去。下一秒，他的胃部變成了無底的黑洞。`,
            opts: [
                { t: "【瘋狂吞噬】不再做人！吞噬周圍的血水與屍體。", r: "你的嘴裂開到耳根，瘋狂地吸食著周圍的一切有機物。你的身體開始異變，長出黑色的鱗片，力量呈幾何級數暴漲。", s: {cha: 6000, pwr: 3000}, log: (n) => `${n}於萬劫熔爐中拋棄人性，吞噬同類屍骸，覺醒饕餮本能，化身怪物。` },
                { t: "【忍辱負重】只吞噬火焰，淬鍊內臟。", r: "你強忍飢餓，張口吞下幽綠的鬼火。內臟被燒穿又重組，你獲得了「九幽冥火」神通，氣息變得陰冷恐怖。", s: {pwr: 5000, bne: 4000}, log: (n) => `${n}生吞九幽冥火，以五臟六腑為爐，煉就冥火神通，意志如鐵。` },
                { t: "【煽動暴亂】將魔氣分給其他人，製造混亂。", r: "你將魔氣感染給十名壯漢，他們發瘋般攻擊守衛。你趁亂躲在屍堆中吸收溢散的能量，福緣深厚。", s: {lck: 5000, cha: 4000}, log: (n) => `${n}散播魔氣製造暴亂，坐收漁翁之利，於混亂中悄然壯大。` }
            ]
        },
        2: {
            title: "第二章：破爐而出 · 京城夢魘",
            text: (n) => `七七四十九天已過，太子親臨地宮，等待開爐取丹。然而，當厚重的青銅爐蓋被掀開時，沒有金光萬丈的仙丹，只有一股滔天的黑氣沖天而起！\n\n${n}緩緩從爐中站起，他已經不再是那個瘦弱的乞丐。他身高丈二，渾身覆蓋著黑金色的骨鎧，背後隱約浮現出一張貪婪的巨口虛影。爐內的數千活人，此刻都已成為了他身體的一部分。\n\n「妖……妖怪！」太子嚇得癱坐在地。護駕的皇家供奉們紛紛祭出法寶，但在現在的${n}面前，這些法寶就像零食一樣可口。他隨手抓住一把飛劍，像啃甘蔗一樣咬碎吞下，發出令人牙酸的聲音。「還不夠……我還很餓……」`,
            opts: [
                { t: "【大快朵頤】吞噬皇家供奉與法寶。", r: "你無視攻擊，將十幾名築基供奉連人帶寶吞入腹中。你的修為瞬間突破，魔威壓塌了地宮。", s: {cha: 10000, pwr: 5000}, log: (n) => `${n}破爐而出，生吞皇家供奉與法寶，將京城地宮化為狩獵場，凶威蓋世。` },
                { t: "【擒賊擒王】直接衝向太子，吸乾真龍之血。", r: "你無視螻蟻，瞬移至太子面前，一口咬住他的喉嚨。太子的皇血讓你產生了質變，你獲得了偽龍魔軀。", s: {pwr: 10000, lck: 5000}, log: (n) => `${n}弒殺當朝太子，沐浴龍血，將人間權貴踩在腳下，魔軀二轉。` },
                { t: "【魔火燎原】噴吐冥火，焚燒整個皇宮。", r: "你張口吐出在爐中煉化的冥火，皇宮化為綠色的火海。無數冤魂被你吸入，你的精神力量暴漲。", s: {bne: 8000, cha: 8000}, log: (n) => `${n}口吐冥火焚燒皇城，收集萬千冤魂，將人間富貴地化為修羅場。` }
            ]
        },
        3: {
            title: "第三章：萬物為食 · 魔臨天下",
            text: (n) => `京城淪陷了。${n}盤踞在皇宮的廢墟之上，他的身體已經膨脹如一座小山，無數黑色的觸鬚從他體內延伸出去，扎入大地，貪婪地汲取著這片土地的靈氣與生機。方圓百里內，草木枯黃，河流乾涸。\n\n各大修仙門派組成的「誅魔聯盟」趕到了。數千名修士結成大陣，試圖煉化這頭絕世凶魔。五顏六色的靈光轟擊在${n}身上，卻只能激起他皮膚上的層層漣漪。\n\n「食物……送上門的食物……」${n}睜開了那隻巨大的獨眼，眼中沒有恐懼，只有興奮。他猛地張開那張彷彿能吞噬天地的巨口，一股恐怖的吸力爆發，天空中的雲層、地上的建築、甚至連修士們打出的靈力光束，統統被倒吸入他的腹中！`,
            opts: [
                { t: "【饕餮盛宴】發動天賦神通「吞天噬地」。", r: "誅魔聯盟的一半修士直接被吸乾了精氣，變成乾屍墜落。你的實力達到了人間界的極限，天道開始排斥你。", s: {cha: 15000, pwr: 8000}, log: (n) => `${n}面對誅魔聯盟發動吞天神通，一口吞掉半數修士，令修仙界聞風喪膽。` },
                { t: "【魔染蒼穹】釋放魔氣侵蝕修士心智，讓他們自相殘殺。", r: "修士們雙眼變紅，調轉槍頭攻擊同伴。你欣賞著這場自相殘殺的戲碼，坐收漁利，福緣大增。", s: {lck: 10000, bne: 8000}, log: (n) => `${n}魔染道心，令正道修士自相殘殺，兵不血刃瓦解聯盟，盡顯魔主手段。` },
                { t: "【肉身硬抗】任由攻擊加身，錘鍊金剛魔體。", r: "你在轟炸中屹立不倒，魔體在毀滅中新生，防禦力達到了變態的程度。體魄屬性突破天際。", s: {pwr: 15000}, log: (n) => `${n}以千人術法淬鍊魔體，不動如山，鑄就萬法不侵之軀。` }
            ]
        },
        4: {
            title: "第四章：聖女降臨 · 歸墟鎮壓",
            text: (n) => `「孽畜！」天空中傳來一聲嬌喝。聖女蘇清月終於看不下去了。她手持「淨世玉瓶」，從虛空中走出。瓶口傾斜，一道白色的淨世神光如瀑布般沖刷而下，這是專門剋制邪魔的力量。\n\n${n}龐大的身軀在神光中冒出滾滾黑煙，劇痛讓他發出驚天動地的嘶吼。但他沒有屈服，反而頂著神光，伸出巨大的魔爪抓向聖女。「管你是神是仙……只要是活的……我就能吃！」\n\n蘇清月眉頭緊鎖，她發現這頭魔物的生命力強得離譜。她只能改變策略，玉手一揮，將歸墟的入口直接開在${n}的頭頂。「既然殺不死你，就將你放逐到永恆的虛無中去餓死吧！」巨大的吸力將${n}連根拔起，拖向那紫色的深淵。\n\n在被吞沒的最後一刻，${n}那巨大的獨眼死死盯著蘇清月，伸出猩紅的舌頭舔了舔嘴唇：「好香的味道……等我回來……我要吃了你……」`,
            opts: [
                { t: "【吞噬神光】臨走前硬吃一口淨世神光。", r: "你的食道被燒爛，但你成功截留了一部分神性力量。光與暗在你體內衝突又融合，混沌之力產生變異。", s: {cha: 20000}, log: (n) => `${n}在被放逐前生吞淨世神光，融合神魔之力，帶著變異魔種墮入歸墟。` },
                { t: "【魔爪留痕】撕下聖女的一塊裙角。", r: "雖然沒能傷到她，但你抓住了她的氣息。這縷氣息將成為你在歸墟中定位她的坐標。福緣與根骨大增。", s: {lck: 15000, bne: 5000}, log: (n) => `${n}強行撕裂聖女霓裳，鎖定其神魂氣息，為日後破界追殺埋下伏筆。` },
                { t: "【自爆分身】炸斷歸墟入口的一角。", r: "你自爆了一部分肉身，炸碎了歸墟的空間壁壘。雖然受傷極重，但你掉落到了歸墟中靈氣最濃郁的「化神池」附近。", s: {pwr: 10000, lck: 10000}, log: (n) => `${n}壯士斷腕，自爆分身干擾傳送，因禍得福落入歸墟寶地。` }
            ]
        }
    }
};

/* 遊戲引擎邏輯 
*/

function startGame() {
    const nameInput = document.getElementById('playerName').value.trim();
    if (!nameInput) {
        alert("修仙之路，豈能無名？請刻下汝之真名！");
        return;
    }
    player.name = nameInput;
    
    // UI 切換
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    
    // 進入路徑選擇
    renderPathSelection();
}

function renderPathSelection() {
    const contentDiv = document.getElementById('storyContent');
    contentDiv.innerHTML = `<div class="story-title">序章：宿命抉擇</div>
    諸天崩潰，大道將傾。<br>
    歸墟的大門已在陰影中敞開，三條截然不同的登天血路在你面前展開。<br><br>
    ${player.name}，這一世，你欲修何種道？`;
    
    const optionList = document.getElementById('optionList');
    optionList.innerHTML = `
        <button onclick="choosePath('LONE')">
            <span class="btn-tag">【孤狼】北境劍修 · 體魄入聖</span>
            背負滅門血仇，手持斷天殘鐵。不修法術，只修肉身與劍意。以凡人之軀，比肩神明。<br>
            <span style="color:#666; font-size:16px;">(核心屬性：體魄、劍意)</span>
        </button>
        <button onclick="choosePath('SCHOLAR')">
            <span class="btn-tag">【寒門】天機謀士 · 因果佈局</span>
            手握乾坤古卷，算盡天下蒼生。以天地為棋盤，眾生為棋子。談笑間，檣櫓灰飛煙滅。<br>
            <span style="color:#666; font-size:16px;">(核心屬性：根骨、福緣)</span>
        </button>
        <button onclick="choosePath('BEGGAR')">
            <span class="btn-tag">【蟻民】混沌魔主 · 吞噬進化</span>
            身處萬劫熔爐，覺醒永生魔種。萬物皆可是食物，神擋吃神，佛擋吃佛。<br>
            <span style="color:#666; font-size:16px;">(核心屬性：混沌、體魄)</span>
        </button>
    `;
    updateStatsUI();
}

function choosePath(pathKey) {
    player.path = pathKey;
    player.chapter = 1;
    // 初始化基礎數值
    if(pathKey === 'LONE') { player.stats.pwr = 1000; player.stats.bne = 500; }
    if(pathKey === 'SCHOLAR') { player.stats.bne = 1000; player.stats.lck = 500; }
    if(pathKey === 'BEGGAR') { player.stats.cha = 1000; player.stats.pwr = 500; }
    
    renderChapter();
}

function renderChapter() {
    const chapterData = STORY_DB[player.path][player.chapter];
    
    // 渲染標題與內容
    const contentDiv = document.getElementById('storyContent');
    contentDiv.innerHTML = `<div class="story-title">${chapterData.title}</div>${chapterData.text(player.name)}`;
    
    // 隱藏結果框與下一步按鈕
    document.getElementById('consequenceBox').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    
    // 渲染選項
    const optionList = document.getElementById('optionList');
    optionList.innerHTML = '';
    
    chapterData.opts.forEach(opt => {
        const btn = document.createElement('button');
        btn.innerHTML = `<span class="btn-tag">${opt.t.split('】')[0] + '】'}</span>${opt.t.split('】')[1]}`;
        btn.onclick = () => makeChoice(opt);
        optionList.appendChild(btn);
    });
    
    updateStatsUI();
}

function makeChoice(opt) {
    // 數值更新
    if(opt.s.pwr) player.stats.pwr += opt.s.pwr;
    if(opt.s.bne) player.stats.bne += opt.s.bne;
    if(opt.s.cha) player.stats.cha += opt.s.cha;
    if(opt.s.lck) player.stats.lck += opt.s.lck;
    
    // 記錄日誌
    player.journal.push(`【第${player.chapter}章】 ` + opt.log(player.name));
    
    // 顯示結果
    const resBox = document.getElementById('consequenceBox');
    resBox.innerText = opt.r;
    resBox.style.display = 'block';
    
    // 清空選項並顯示下一步
    document.getElementById('optionList').innerHTML = '';
    document.getElementById('nextBtn').style.display = 'block';
    
    updateStatsUI();
}

function handleNext() {
    player.chapter++;

    const chapterData = STORY_DB[player.path][player.chapter];

    if (!chapterData) {
        const contentDiv = document.getElementById('storyContent');
        contentDiv.innerHTML = `
            <div class="story-title">【當前章節已完結】</div>
            <p>你的宿命線暫時走到這裡。</p>
            <p>前方，是尚未書寫的未來。</p>
        `;

        document.getElementById('consequenceBox').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('optionList').innerHTML = '';
        return;
    }

    renderChapter();
}


function updateStatsUI() {
    const s = player.stats;
    document.getElementById('statsBar').innerHTML = `
        <span>道號: ${player.name}</span>
        <span>體魄: ${s.pwr}</span>
        <span>根骨: ${s.bne}</span>
        <span>混沌: ${s.cha}</span>
        <span>福緣: ${s.lck}</span>
    `;
}
/* ============================================================
   【第二階段：5~8 章 · 歸墟爭鋒】
   包含：三線交會劇情、數值爆炸成長、宿命死鬥
   ============================================================ */

// 擴充孤狼線 (LONE) 5-8 章
Object.assign(STORY_DB.LONE, {
    5: {
        title: "第五章：歸墟亂流 · 狂龍遇猛虎",
        text: (n) => `歸墟內部的空間亂流如同無數把看不見的鈍刀，瘋狂切割著${n}的肉身。若非他在北境冰川練就了金剛不壞之軀，此刻早已化為齏粉。隨著一聲震耳欲聾的空間爆鳴，他雙腳重重踏在了一塊懸浮的黑色巨岩之上，眼前豁然開朗——這裡是歸墟的核心，「化神池」。\n\n然而，這裡並不止他一人。在池水的左側，一名身著殘破儒衫的書生正懸空而立，手中捧著一卷散發著幽幽古韻的竹簡，周身環繞著無數金色的因果絲線，彷彿將這混亂的空間梳理成了他的棋盤。在池水的右側，一團人形的漆黑霧氣正在蠕動，那是一個散發著令人作嘔的腐爛氣息的怪物，它偶爾露出的森白獠牙和獨眼，充滿了對生靈的極致飢渴。\n\n三人呈掎角之勢對峙。空氣在這一刻凝固了。${n}握緊手中的斷天殘鐵，感受到了兩股截然不同但同樣恐怖的威脅。那是宿命的吸引，也是天敵般的排斥。書生抬起頭，目光如炬；魔物咧開嘴，垂涎欲滴。${n}冷哼一聲，渾身暗金色的血氣如狼煙般沖天而起：「不管你們是誰，擋我路者，殺無赦！」`,
        opts: [
            { t: "【霸道開路】無視兩人，直接衝向化神池中心！", r: "你如同一顆燃燒的流星撞入戰場，狂暴的氣浪逼退了書生的因果線，也震散了魔物的黑霧。你以絕對的蠻力在三人中佔據了C位，霸氣縱橫。", s: {pwr: 30000, bne: 15000}, log: (n) => `${n}於三強對峙中率先發難，以絕對肉身力量震懾書生與魔主，霸佔化神池核心。` },
            { t: "【劍意試探】向兩人各揮出一道斷天劍氣。", r: "劍氣破空，書生以文字化盾擋下，魔物則張口吞噬了劍光。這一擊讓你摸清了底細：一個擅守，一個擅吞。知己知彼，百戰不殆。", s: {bne: 25000, lck: 10000}, log: (n) => `${n}以劍氣試探諸天宿敵，洞察因果與混沌之秘，為死戰佔得先機。` },
            { t: "【挑釁全場】將斷劍插入地面，邀兩人同時出手。", r: "你的狂傲激怒了另外兩位天驕。三股氣勢在空中瘋狂碰撞，你的體魄在這種極致的壓迫下再次突破極限，隱隱發出雷鳴。", s: {pwr: 40000, cha: 5000}, log: (n) => `${n}狂傲無邊，獨戰兩大天命之子氣場，置之死地而後生，體魄再登高峰。` }
        ]
    },
    6: {
        title: "第六章：聖女法相 · 梵天鎮魔",
        text: (n) => `就在三人劍拔弩張之際，頭頂原本昏暗的虛空突然亮起刺目的聖光。蘇清月的真身雖未親至，但她投下的「大梵鎮魔塔」法相已然降臨。那是一座高達萬丈、由無數太古符文構築而成的金色巨塔，帶著天道意志的無上威壓，轟然砸向化神池中的三人。\n\n「歸墟重地，豈容爾等螻蟻染指！」蘇清月的聲音如滾滾天雷，震得${n}耳膜溢血。巨大的重力瞬間增加了千倍，腳下的黑岩寸寸崩裂。書生的因果線開始崩斷，魔物的黑霧被聖光灼燒得滋滋作響。${n}感覺全身骨骼都在悲鳴，但他脊樑卻挺得筆直。他看向另外兩人，吼道：「喂！那邊的酸秀才，還有那個噁心的吃貨！這娘們想把我們壓成肉泥，先聯手幹碎這破塔，如何？！」\n\n書生擦去嘴角的血漬，微微點頭；魔物發出一聲嘶吼，黑氣暴漲。三位宿敵，在這一刻達成了短暫而致命的默契。`,
        opts: [
            { t: "【擎天一柱】燃燒壽元，雙手托舉鎮魔塔底座！", r: "你化身太古巨人，雙手死死撐住下落的金塔。全身肌肉纖維崩斷又重生，你的血液染紅了塔身，卻硬生生止住了它的下墜趨勢！", s: {pwr: 50000, bne: 20000}, log: (n) => `${n}力拔山兮氣蓋世，以凡人血肉之軀硬撼天道鎮魔塔，為盟友爭取了反擊契機。` },
            { t: "【弱點洞察】尋找鎮魔塔符文流動的破綻。", r: "你在極致的重壓下開啟了「心眼」，發現了金塔左側符文的凝滯之處。一指點出，大喊「攻這裡！」，引導另外兩人合力破局。", s: {bne: 40000, lck: 20000}, log: (n) => `${n}於絕境中洞察天道法相破綻，指揮宿敵聯手攻堅，展現無雙戰鬥智慧。` },
            { t: "【借力淬體】利用鎮魔金光淬鍊斷天殘鐵。", r: "你瘋狂地引導聖光洗刷手中的斷劍，殘鐵在鎮壓下剝落銹跡，露出了更加猙獰的真容。劍意暴漲，混沌氣息瀰漫。", s: {pwr: 35000, cha: 25000}, log: (n) => `${n}視天道鎮壓為打鐵爐，藉助聖女之力重鑄斷天神兵，凶威更甚。` }
        ]
    },
    7: {
        title: "第七章：三位一體 · 弒神序曲",
        text: (n) => `這是一場足以載入諸天史冊的戰鬥。${n}充當了最鋒利的矛，斷天劍意化作一條逆流而上的黑龍，每一次斬擊都讓鎮魔塔劇烈顫抖；書生在後方展開古卷，無數文字化作鎖鏈，死死纏繞住金塔的靈力節點，封鎖其修復能力；魔物則化作一張遮天蔽日的巨口，瘋狂吞噬著溢散的聖光能量，讓蘇清月的法相越來越虛弱。\n\n「不知死活！」虛空中傳來蘇清月惱羞成怒的呵斥。鎮魔塔底座突然裂開，一柄純白色的「裁決聖劍」從中刺出，直指頂在最前面的${n}。這一劍蘊含了規則之力，避無可避！\n\n「來得好！」${n}不退反進，體內氣血燃燒如沸騰的岩漿。他感受到身後傳來兩股力量——書生的「固」字訣加持在他的骨骼上，魔物的「暴」之氣灌入他的經脈。三人力量合一，${n}揮出了他人生中最巔峰的一劍！`,
        opts: [
            { t: "【正面硬剛】以斷劍對撞裁決聖劍，死戰不退！", r: "「咔嚓！」兩劍相交，空間破碎。裁決聖劍竟被你一劍斬斷！巨大的衝擊波將鎮魔塔徹底震碎，你全身浴血，宛如戰神。", s: {pwr: 60000, bne: 30000}, log: (n) => `${n}集合三位天命者之力，正面斬斷天道裁決聖劍，粉碎鎮魔塔，一戰封神。` },
            { t: "【卸力反殺】引導聖劍力量轟擊歸墟壁壘。", r: "你以太極之意牽引劍鋒，藉助聖女的全力一擊轟開了歸墟深處的時空壁壘。一條通往更高維度的裂縫出現了！", s: {lck: 50000, bne: 40000}, log: (n) => `${n}借天道之劍斬開時空壁壘，於必死之局中開闢生路，算計通天。` },
            { t: "【吞噬劍意】用肉身硬吃這一劍，強行融合規則。", r: "聖劍貫穿了你的胸膛，但你死死卡住劍身，利用魔種將天道規則碎片強行留在體內。雖受重創，但你獲得了「審判」屬性。", s: {cha: 60000, pwr: 20000}, log: (n) => `${n}以胸膛為鞘接下聖劍，強行吞噬天道規則，肉身融合神性與魔性。` }
        ]
    },
    8: {
        title: "第八章：虛空崩塌 · 宿命分道",
        text: (n) => `鎮魔塔的崩碎引發了連鎖反應，化神池徹底失控，演變成了吞噬一切的黑洞。蘇清月的法相發出一聲不甘的尖叫後消散，但她臨走前引爆了剩餘的能量，試圖拉著三人同歸於盡。\n\n狂暴的空間亂流將三人強行分開。書生被捲入了代表「過去」的時間長河，魔物被吸入了代表「混亂」的深淵位面。而${n}則抓著一塊鎮魔塔的殘片，被甩向了未知的星域。\n\n在視線即將被黑暗吞沒的最後一刻，三人的目光再次交匯。沒有感激，只有更深沉的戰意。他們都知道，這次合作只是為了生存。下一次見面，為了爭奪唯一的超脫機會，他們必將把對方的頭顱斬下。${n}抹去臉上的血水，對著虛空豎起了中指，隨後轉身投入了那未知的黑暗之中。歸墟之行結束了，但諸天爭霸的序幕，才剛剛拉開。`,
        opts: [
            { t: "【掠奪核心】臨走前撈走化神池的一團本源之水。", r: "你冒著手臂被絞碎的風險，奪取了最精純的化神本源。這團液體將成為你日後重塑神體的關鍵。福緣爆表。", s: {lck: 60000, bne: 30000}, log: (n) => `${n}在歸墟崩塌之際虎口奪食，搶走化神池本源，帶著驚天造化離開。` },
            { t: "【穩固道心】在傳送亂流中磨練意志。", r: "你無視肉身的撕裂，在時空風暴中閉目冥想，將方才大戰的感悟融會貫通。你的靈魂強度達到了前所未有的高度。", s: {bne: 80000}, log: (n) => `${n}視時空亂流為修行地，於生死間悟道，心境圓滿，根骨通神。` },
            { t: "【追殺聖女】鎖定聖女法相消散的軌跡。", r: "你沒有選擇逃跑，而是藉著爆炸的衝力，強行追蹤聖女的本體坐標。雖然此行九死一生，但你找到了通往天道大本營的路。", s: {pwr: 50000, cha: 50000}, log: (n) => `${n}瘋魔無比，不退反進，追蹤天道聖女氣息殺入域外，誓要斬草除根。` }
        ]
    }
});

// 擴充寒門線 (SCHOLAR) 5-8 章
Object.assign(STORY_DB.SCHOLAR, {
    5: {
        title: "第五章：歸墟棋盤 · 三子落位",
        text: (n) => `歸墟核心，亂流肆虐。${n}腳踏虛空，手中的《乾坤古卷》自動展開，無數文字構築成一個巨大的防護罩，將空間風暴隔絕在外。他推了推鼻樑上並不存在的眼鏡（或者是下意識的儒生習慣），目光冷靜地掃視著突然闖入這片棋盤的另外兩枚「棋子」。\n\n左側，一名渾身浴血、手持斷劍的狂戰士正暴力地劈開空間亂流，那股一往無前的慘烈氣勢令人動容。右側，一團不可名狀的黑色魔影正在吞噬周圍的空間碎片，彷彿永遠填不滿的黑洞。${n}心中微動，因果線在指尖跳躍：「一個代表極致的『力』，一個代表極致的『慾』。加上我這極致的『智』，這歸墟，熱鬧了。」\n\n三人呈三角形對峙，氣機牽引之下，整片空間都發出了不堪重負的呻吟。那狂戰士眼中滿是戰意，那魔影眼中滿是貪婪。${n}淡然一笑，手中摺扇輕搖：「二位，相逢即是有緣，但在這化神池前，這緣分恐怕是孽緣啊。」`,
        opts: [
            { t: "【因果佈局】悄悄在兩人身上種下因果標記。", r: "你言語客氣，暗地裡卻通過古卷將兩人的氣機與化神池的兇險禁制相連。一旦開戰，他們將率先遭受反噬。智商碾壓。", s: {bne: 30000, lck: 20000}, log: (n) => `${n}於談笑間在兩大宿敵身上種下因果暗雷，將戰場主動權牢牢握在手中。` },
            { t: "【合縱連橫】傳音給劍修，提議先殺魔物。", r: "你洞察到劍修的性格剛烈，與魔物的陰邪不合。一番唇舌挑撥，劍修果然將殺氣轉向了魔影。你坐山觀虎鬥。", s: {lck: 40000, bne: 15000}, log: (n) => `${n}施展縱橫之術，挑撥劍修與魔主互鬥，盡顯謀士本色。` },
            { t: "【文字鎮壓】直接寫下一個「定」字，試探深淺。", r: "金色的巨大「定」字壓向兩人。劍修一力破之，魔物一口吞之。雖未奏效，但你已收集到了兩人的能量頻率數據。", s: {pwr: 20000, bne: 30000}, log: (n) => `${n}以儒道真言試探群雄，收集宿敵情報，為後續佈局打下基礎。` }
        ]
    },
    // ... 為了節省篇幅但保持質量，寒門線6-8章的邏輯結構與孤狼線類似，但文案完全不同，此處省略重複結構代碼，直接套用通用結構生成特定文案 ...
    6: {
        title: "第六章：天道降罰 · 絕地求生",
        text: (n) => `聖女蘇清月的「大梵鎮魔塔」帶著毀天滅地的威勢落下。${n}眼中的數據流瘋狂刷新，他看到了這座塔背後運行的三千六百道天道法則。這不是蠻力可以對抗的，這是規則的碾壓。\n\n「可笑。」${n}冷哼一聲，「這世間萬物皆有裂痕。」他看向身旁被壓得吐血的劍修和魔物，大聲喝道：「我在塔身東南角開一個口子，魔物去吞噬靈氣，劍修去斬斷中樞！不想死就聽我指揮！」\n\n在那一刻，${n}成了這個臨時小隊的大腦。`,
        opts: [
            { t: "【精密計算】找出鎮魔塔的邏輯死循環。", r: "你發現聖女的法相存在能量延遲，精準地打出一道干擾符文，令金塔在空中停滯了0.1秒。這0.1秒就是生機！", s: {bne: 50000, lck: 20000}, log: (n) => `${n}以凡人智慧計算天道運行邏輯，製造出剎那生機，震驚聖女。` },
            { t: "【欺天瞞地】修改周圍的空間坐標。", r: "你用古卷扭曲了空間，讓鎮魔塔誤以為目標已經消失。壓迫力驟減，你們獲得了喘息之機。", s: {lck: 50000, cha: 20000}, log: (n) => `${n}施展欺天之術，誤導天道法相攻擊落空，手段神鬼莫測。` },
            { t: "【儒道浩然】燃燒文膽，硬頂天威。", r: "你不再躲閃，朗誦聖賢文章，浩然正氣化作光柱頂住金塔。雖然七竅流血，但這份骨氣讓另外兩人刮目相看。", s: {pwr: 40000, bne: 30000}, log: (n) => `${n}以文弱之軀燃燒浩然正氣，硬頂鎮魔金塔，證明天地有正氣。` }
        ]
    },
    7: {
        title: "第七章：算盡天機 · 逆轉乾坤",
        text: (n) => `戰鬥進入白熱化。在${n}的精準調度下，三人就像一台精密的殺戮機器。劍修負責破防，魔物負責削弱，而${n}則負責控場與絕殺。每當蘇清月試圖修復鎮魔塔，${n}的「禁」字訣就會準時降臨；每當聖女發動範圍攻擊，${n}就會提前三秒預警。\n\n蘇清月終於怒了，裁決聖劍斬下。${n}眼神冰冷，手中摺扇猛地合上：「就是現在！陷阱發動！」原來他早在戰鬥開始時，就在虛空中布下了一張無形的因果大網。`,
        opts: [
            { t: "【因果反噬】將聖劍的傷害轉移回聖女本體。", r: "你啟動了「移花接木」大陣，聖劍斬在你們身上，傷口卻出現在蘇清月的法相上。她發出淒厲的慘叫，法相崩潰。", s: {lck: 70000, bne: 30000}, log: (n) => `${n}佈局良久，以彼之道還施彼身，利用因果律重創聖女法相。` },
            { t: "【絕殺一筆】在聖劍落下前，改寫其符文規則。", r: "你用鮮血在空中改寫了聖劍的一個符文，將「裁決」改為「潰散」。聖劍在臨頭時化作漫天光點。", s: {bne: 80000, cha: 20000}, log: (n) => `${n}以筆代刀，臨陣篡改天道符文，化解必死殺招，技驚四座。` },
            { t: "【氣運剝奪】趁亂斬斷聖女與本體的聯繫。", r: "你祭出古卷，強行切斷了法相的能量供給。法相瞬間枯萎，你順手牽羊奪走了一縷神性。", s: {lck: 60000, pwr: 20000}, log: (n) => `${n}釜底抽薪，切斷天道供能，令聖女法相枯竭，盡顯梟雄手段。` }
        ]
    },
    8: {
        title: "第八章：棋局未終 · 虛空別離",
        text: (n) => `歸墟崩塌，棋盤碎裂。${n}看著被吸入不同時空的劍修和魔物，嘴角露出一絲複雜的笑意。他知道，這兩個人將是他成神路上最大的變數。劍修的力太強，魔物的慾太盛，這兩者都難以完全算計。\n\n「下次再見，或許就是在這棋盤對面了。」${n}整理了一下凌亂的衣衫，即使身處毀滅的亂流中，他依然保持著讀書人的風度。他選定了一條充滿未知符文的時空裂縫，一步跨入。他要去的地方，是傳說中記載宇宙真理的「萬法圖書館」。`,
        opts: [
            { t: "【保留火種】將歸墟的坐標刻錄在古卷中。", r: "你沒有貪圖寶物，而是記錄了這裡的空間參數。這將成為你日後反攻天道的前哨站。目光長遠。", s: {bne: 90000}, log: (n) => `${n}於毀滅中記錄歸墟坐標，為日後反攻天道埋下伏筆，深謀遠慮。` },
            { t: "【順手牽羊】捲走鎮魔塔崩碎的符文石板。", r: "你利用空間亂流，捲走了記載天道秘術的石板。知識就是力量，這波血賺。", s: {lck: 50000, bne: 50000}, log: (n) => `${n}臨走前掠奪天道石板，獲取無上秘術，滿載而歸。` },
            { t: "【亂流悟道】在時空穿梭中推演時間法則。", r: "你觀察著光陰的流逝，頭髮瞬間變白又變黑。你觸摸到了時間法則的邊緣。", s: {cha: 60000, bne: 40000}, log: (n) => `${n}於時空亂流中參悟光陰之妙，觸摸時間法則，境界大增。` }
        ]
    }
});

// 擴充蟻民線 (BEGGAR) 5-8 章
Object.assign(STORY_DB.BEGGAR, {
    5: {
        title: "第五章：歸墟食堂 · 兩道主菜",
        text: (n) => `對${n}來說，歸墟不是絕地，而是一個巨大的自助餐廳。空間亂流？嘎嘣脆，像薯片。紫色雷霆？有點麻，像跳跳糖。他一路吃到了歸墟核心，體型已經膨脹到了三丈高，渾身流淌著黑金色的魔紋。\n\n在化神池畔，他看到了兩個「極品食材」。一個氣血旺盛得像人形蠻龍，渾身散發著誘人的肉香（孤狼）；另一個靈魂純淨得像水晶，散發著清冽的墨香（書生）。${n}的口水瞬間如瀑布般流下，滴在地上腐蝕出深坑。\n\n「好餓……好香……」${n}發出含糊不清的嘶吼，巨大的獨眼貪婪地在兩人身上掃視。那兩人顯然被他的吃相噁心到了，紛紛露出警惕的神色。${n}嘿嘿一笑，肚子發出雷鳴般的轟響：「你們……是自己跳進我嘴裡，還是我把你切開了吃？」`,
        opts: [
            { t: "【暴食降臨】張開深淵巨口，試圖將兩人一口吞！", r: "你發動天賦神通，巨大的吸力讓兩人站立不穩。雖然沒能吞掉，但你吸走了他們逸散的大量靈氣，打了個飽嗝。爽！", s: {cha: 40000, pwr: 20000}, log: (n) => `${n}見面即開吃，試圖吞噬兩大天命之子，雖未成功但飽餐靈氣，凶威滔天。` },
            { t: "【魔威壓制】釋放混沌領域，污染周圍空間。", r: "你將周圍化作黑色的沼澤。書生的因果線被腐蝕，劍修的腳步變沉重。這裡是你的主場。", s: {cha: 50000, bne: 10000}, log: (n) => `${n}釋放混沌領域污染歸墟核心，將戰場化作適合自己的魔域，壓制強敵。` },
            { t: "【偽裝示弱】縮小身形，裝作人畜無害等待偷襲。", r: "你瞬間變成一個瘦弱的少年，氣息收斂。那兩人一愣，互相防備起來。你躲在暗處流口水，等待背刺的機會。", s: {lck: 40000, cha: 20000}, log: (n) => `${n}狡詐如狐，示敵以弱，在兩大強者眼皮底下潛伏，伺機而噬。` }
        ]
    },
    6: { // 簡化結構，對應LONE線的第6章
        title: "第六章：天道外賣 · 聖光大餐",
        text: (n) => `頭頂突然亮瞎眼的聖光讓${n}很不爽。蘇清月的法相降臨，那座「大梵鎮魔塔」在他眼裡根本不是什麼威脅，而是一塊巨大的、金燦燦的壓縮餅乾！\n\n「卑賤的魔物……」蘇清月的聲音還沒說完，${n}就已經發出了一聲興奮的咆哮：「加餐了！」\n\n巨大的壓力襲來，${n}的骨骼被壓碎，但他毫不在意。魔種的特性就是越傷越強，越餓越狂。他看了一眼旁邊苦苦支撐的「肉排」（劍修）和「甜點」（書生），吼道：「喂！別把我的食物弄壞了！這塊大的金餅歸我，那娘們歸你們！」`,
        opts: [
            { t: "【生吞法寶】直接張嘴啃咬鎮魔塔的底座！", r: "你的牙齒崩斷了，但新的獠牙瞬間長出，更硬更鋒利。你硬生生從塔座上咬下一塊符文金屬，嚼得嘎嘣響。蘇清月都看傻了。", s: {cha: 60000, pwr: 10000}, log: (n) => `${n}兇殘至極，將天道至寶鎮魔塔當作食物啃食，令聖女膽寒。` },
            { t: "【腐蝕污染】向鎮魔塔噴吐萬年積累的胃酸。", r: "黑色的酸液淋在金塔上，神聖符文開始腐爛黯淡。塔的威力驟減，你立大功了。", s: {cha: 50000, lck: 20000}, log: (n) => `${n}噴吐魔界毒液腐蝕天道法寶，大幅削弱聖女攻勢，污穢之能驚世。` },
            { t: "【吸收衝擊】將鎮魔塔的重力轉化為生長能量。", r: "你變成一團軟泥，承受了最大的攻擊面積。重力被轉化為動能，你的體型再次暴漲一倍。", s: {pwr: 40000, bne: 30000}, log: (n) => `${n}化身軟泥魔怪，吸收天道鎮壓之力轉化為生長養分，越打越強。` }
        ]
    },
    7: { // 簡化結構，對應LONE線的第7章
        title: "第七章：三魔亂舞 · 暴食盛宴",
        text: (n) => `戰鬥？不，這是一場自助餐。${n}徹底放飛了自我。劍修在前砍殺，他在後面吸溜那些濺出來的聖光碎片；書生在控場，他在趁機偷吃書生佈下的因果線（雖然有點塞牙）。\n\n蘇清月祭出裁決聖劍時，${n}感覺到了前所未有的食慾。那把劍……是純粹的高維能量！\n\n「那是我的！」${n}不顧劍修和書生的阻攔，竟然主動迎向了聖劍。就在劍修斬斷劍身的一瞬間，${n}張開大口，將斷裂的半截聖劍直接吞入腹中！轟！恐怖的神聖力量在他胃裡爆炸，把他的肚子炸出一個大洞，但魔種瘋狂運轉，瞬間修復，並將這股力量同化。`,
        opts: [
            { t: "【神魔同體】強行消化聖劍碎片，獲得光暗雙屬性。", r: "你痛苦地打滾，但當你站起來時，黑氣中夾雜著金光。你進化了，成為了諸天唯一的「聖魔」。", s: {cha: 80000, pwr: 20000}, log: (n) => `${n}生吞裁決聖劍碎片，強行融合神聖之力，進化為光暗同體的聖魔形態。` },
            { t: "【吐息反擊】將無法消化的聖劍能量噴回去。", r: "你像一門重砲，將混合了胃酸的聖光噴向蘇清月。這噁心又致命的一擊直接轟碎了她的護體蓮花。", s: {pwr: 60000, lck: 30000}, log: (n) => `${n}將聖劍能量混合魔氣噴吐反擊，重創聖女本體，傷害性與侮辱性極強。` },
            { t: "【趁火打劫】趁另外兩人攻擊時，偷吸他們的氣血。", r: "你在混戰中不分敵我地吸取周圍所有能量。劍修和書生都感覺身體一虛，對你怒目而視。你卻滿面紅光。", s: {cha: 70000, bne: 20000}, log: (n) => `${n}在聯手對敵時仍不忘偷吸隊友氣血，貪婪本性暴露無遺，魔威更盛。` }
        ]
    },
    8: { // 簡化結構，對應LONE線的第8章
        title: "第八章：吃飽喝足 · 尋找下家",
        text: (n) => `歸墟炸了。對${n}來說，這就像是飯桌被掀了。蘇清月跑了，留下一地雞毛。空間亂流捲起了${n}龐大的身軀。\n\n他看著劍修和書生被捲走，心中竟然有一絲惋惜——多好的儲備糧啊，可惜這次沒吃成。不過沒關係，魔種告訴他，這諸天萬界還有無數美味的強者等待他去品嚐。\n\n「下次……一定吃了你們……」${n}拍了拍圓滾滾的肚皮，心滿意足地順著一道散發著濃郁肉香（其實是妖界氣息）的空間裂縫飄去。他的傳說，將在那片充滿強大妖獸的土地上繼續書寫。`,
        opts: [
            { t: "【打包外帶】臨走前吞噬大片歸墟空間碎片。", r: "你把空間碎片當薯片存就在胃裡。這些碎片讓你獲得了「虛空穿梭」的天賦。以後想去哪吃就去哪吃。", s: {cha: 90000, lck: 10000}, log: (n) => `${n}吞噬歸墟空間碎片，覺醒虛空穿梭天賦，成為諸天最自由的獵食者。` },
            { t: "【沉睡進化】在亂流中結繭，消化此戰所得。", r: "你化作一顆巨大的黑蛋，在虛空中漂流。當你破殼之日，便是這諸天顫抖之時。", s: {bne: 100000}, log: (n) => `${n}於虛空亂流中結繭沉睡，消化歸墟所得，為下一階段的究極進化積蓄力量。` },
            { t: "【魔種分裂】散播無數小魔種進入各個位面。", r: "你將身體分裂出萬千孢子，灑向萬界。這些分身將為你源源不斷地提供養分。真正的天災。", s: {cha: 70000, lck: 30000}, log: (n) => `${n}散播萬千魔種孢子於諸天萬界，以眾生為養料，布下吞天大局。` }
        ]
    }
});

/* ------------------------------------------------------------
   邏輯更新：處理從 Ch4 -> Ch5 的過渡以及 Ch8 -> Ch9 的過渡
   ------------------------------------------------------------ */

// 覆寫原有的 handleNext 函數以支持更多章節
window.handleNext = function() {
    player.chapter++;
    
    // 如果章節 > 8，說明第二階段結束
    if (player.chapter > 8) {
        const contentDiv = document.getElementById('storyContent');
        contentDiv.innerHTML = `<div class="story-title">【第二階段 · 歸墟爭鋒 完成】</div>
        <p>歸墟已碎，三位天命者被放逐至不同的時空維度。</p>
        <p>百年歲月匆匆過，當你們再次相遇時，將是真正的「相愛相殺」。</p>
        <p style="color:var(--gold); font-weight:bold; font-size: 24px;">數值已暴漲，神格已雛形。</p>
        <p>請等待「第三階段程式碼（9~12章）」注入以繼續這場宿命死鬥...</p>
        <p>(請在對話框中輸入「繼續」以獲取 9~12 章代碼)</p>`;
        
        document.getElementById('consequenceBox').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('optionList').innerHTML = '';
        
        // 更新狀態欄，讓玩家看到數值的變化
        updateStatsUI();
    } else {
        renderChapter();
    }
};

// 確保如果玩家還在第4章結束畫面，能刷新出按鈕
if(player.chapter === 5) {
    renderChapter();
} else if (player.chapter === 4 && document.getElementById('nextBtn').style.display === 'none') {
   // 如果玩家卡在第4章結束文字，手動刷新一下
   document.getElementById('storyContent').innerHTML += `<br><br><button onclick="handleNext()" style="background:var(--crimson); color:#fff; padding:15px; border:none; cursor:pointer;">開啟第五章：歸墟爭鋒</button>`;
}

console.log("【系統提示】第二階段數據（5~8章）已注入成功。宿命之輪開始轉動。");
/* ============================================================
   【第三階段：9~12 章 · 相愛相殺】
   包含：高維戰場、極致算計、三方混戰與聯手
   ============================================================ */

// 擴充孤狼線 (LONE) 9-12 章
Object.assign(STORY_DB.LONE, {
    9: {
        title: "第九章：星空古路 · 冤家路窄",
        text: (n) => `離開歸墟百年，${n}已在「蠻荒星域」殺出了赫赫威名，被尊為「碎星武神」。今日，在一座懸浮於宇宙深處的太古仙墓前，他再次感應到了那兩股令人厭惡又熟悉的氣息。\n\n仙墓開啟，一把帝兵「量天尺」出世。${n}剛要伸手，一道金色的因果線突然纏住了他的手腕，緊接著一張巨大的魔口從虛空中探出，一口咬向那把帝兵！\n\n「該死的酸秀才！貪吃的廢物！」${n}怒極反笑，反手一拳轟碎了虛空。只見書生站在一顆隕石上，羽扇綸巾，笑得極其欠揍；而那魔物（前世的蟻民）則化作黑洞，正試圖將仙墓連根吞掉。\n\n「武夫，這量天尺與我有緣，你把握不住。」書生淡淡說道。\n「好餓……它是巧克力味的……」魔物流著口水。\n\n仇人見面，分外眼紅。這一百年的賬，今天要一起算！`,
        opts: [
            { t: "【力破萬法】不管帝兵，先給書生臉上一拳！", r: "你無視量天尺的誘惑，縮地成寸，一拳轟在書生那張俊臉上。書生的護體文字盡碎，鼻血狂噴。你感到無比解氣！", s: {pwr: 100000, bne: 50000}, log: (n) => `${n}於星空古路重逢宿敵，捨棄帝兵不顧，先爆錘書生一拳，念頭通達。` },
            { t: "【借刀殺人】把魔物踢向仙墓守護獸。", r: "你一腳將貪吃的魔物踹進了仙墓深處，喚醒了沉睡的星空巨獸。魔物被迫與巨獸廝殺，你趁亂奪取帝兵。", s: {lck: 80000, bne: 60000}, log: (n) => `${n}一腳踹飛魔主去扛怪，坐收漁翁之利奪取帝兵，戰術髒得令人髮指。` },
            { t: "【一挑二】開啟「修羅領域」，同時鎮壓兩人。", r: "你燃燒精血，顯化萬丈法相，將兩人同時圈入攻擊範圍。雖然受傷頗重，但你的霸道讓整片星域顫抖。", s: {pwr: 150000, cha: 50000}, log: (n) => `${n}狂性大發，以一敵二硬撼兩大天命之子，星空染血，威震八荒。` }
        ]
    },
    10: {
        title: "第十章：絕境陷害 · 誰是獵人",
        text: (n) => `爭奪帝兵之後，三人並未散去，而是互相追殺至「亂星海」。這裡到處是時空裂縫。書生突然停下腳步，轉身對${n}露出一個詭異的微笑：「武夫，你中計了。」\n\n原來，書生早已佈下「十方絕滅大陣」，卻故意示弱引${n}入局。無數殺伐文字化作鎖鏈，將${n}困在原地。與此同時，魔物從地底鑽出，張開大嘴準備坐享其成。\n\n「雖然我很想殺你，」${n}渾身浴血，骨骼在鎖鏈下咔咔作響，眼中卻燃燒著瘋狂的火焰，「但你們是不是忘了，老子最強的……就是抗揍啊！！！」\n\n${n}不退反進，竟然主動引爆了體內的一處竅穴，巨大的爆炸力連同大陣一起炸碎。他如同一頭受傷的暴龍，衝到書生面前，一把掐住了對方的脖子；同時一腳踩住了試圖偷襲的魔物尾巴。`,
        opts: [
            { t: "【暴力破局】掐著書生的脖子當武器，橫掃魔物。", r: "你把書生當成一根人棍，瘋狂掄起來砸向魔物。書生慘叫，魔物被砸得變形。這場面太美，不敢看。", s: {pwr: 180000, cha: 80000}, log: (n) => `${n}破除殺陣，將天機謀士當作兵器掄砸魔主，極致羞辱兩大宿敵。` },
            { t: "【絕地反殺】引導亂星海的罡風灌入兩體內。", r: "你利用肉身優勢，強行抓著兩人衝入罡風層。你皮糙肉厚沒事，那兩人被刮得皮開肉綻，不得不求饒。", s: {bne: 120000, pwr: 100000}, log: (n) => `${n}拖著宿敵同歸於盡般衝入罡風層，以肉身優勢逼退強敵，狠辣無雙。` },
            { t: "【暫時結盟】感應到聖女追兵，強行逼兩人合作。", r: "你察覺到蘇清月的氣息逼近，一巴掌把兩人拍醒：「別打了！那個瘋婆娘來了！先幹她！」三人瞬間變臉，組成防禦陣型。", s: {lck: 100000, bne: 80000}, log: (n) => `${n}在內鬥中敏銳察覺外敵，一巴掌拍醒宿敵，瞬間轉火對抗天道追兵。` }
        ]
    },
    11: {
        title: "第十一章：天道圍剿 · 背靠背的死敵",
        text: (n) => `這是一場極其荒謬的戰鬥。${n}與書生、魔物背靠背站立，周圍是蘇清月帶領的三千天道執法者，以及十位大羅金仙級別的傀儡。\n\n「那邊那個拿筆的，要是敢在背後捅我刀子，我先捏爆你的頭！」${n}一拳轟碎一名金仙傀儡，大聲吼道。\n「粗鄙。」書生雖然嘴硬，但手中的筆卻在空中畫出一道巨大的「盾」字，替${n}擋下了一記致命偷襲，「你要是死了，誰來當肉盾？」\n「餓……好多肉……」魔物則完全不顧防守，瘋狂吞噬著周圍的執法者，身體越變越大，為兩人分擔了大量火力。\n\n明明前一刻還要置對方於死地，此刻為了活命，三人卻展現出了比親兄弟還可怕的默契。${n}負責衝鋒鑿穿陣型，書生負責控場與補刀，魔物負責清掃戰場與威懾。`,
        opts: [
            { t: "【捨身為盾】主動替書生擋下一記天劫，換取其絕殺機會。", r: "你硬抗天雷，後背一片焦黑。書生愣了一瞬，隨即眼中寒芒爆閃，發動禁術秒殺了敵方主帥。「還你的人情！」他吼道。", s: {pwr: 200000, bne: 100000}, log: (n) => `${n}於混戰中替宿敵擋災，激發書生爆發禁術，兩人間產生了詭異的羈絆。` },
            { t: "【投擲魔物】把吃得太飽的魔物當炸彈扔進敵群。", r: "「幫你消化一下！」你抓起圓滾滾的魔物扔出去。魔物在敵群中自爆魔氣，炸死一片。魔物爬回來罵罵咧咧，但眼神中居然有一絲爽快。", s: {cha: 150000, pwr: 150000}, log: (n) => `${n}將魔主當作生化武器投擲，瞬間清空戰場，配合之默契令人髮指。` },
            { t: "【領袖氣質】接過指揮權，號令兩人結「三才殺陣」。", r: "你一聲令下，三人氣機相連。力、智、欲三者合一，爆發出的力量直接撕開了天道包圍圈。", s: {lck: 120000, bne: 120000}, log: (n) => `${n}強勢統御兩大天驕，結成三才殺陣，鑿穿天道包圍圈，盡顯霸主風範。` }
        ]
    },
    12: {
        title: "第十二章：分贓不均 · 下次一定殺你",
        text: (n) => `殺出重圍後，三人躲在一顆荒蕪星球上分贓。天道執法者的儲物袋堆成了一座小山。\n\n「我要七成。」${n}擦著身上的血，理直氣壯地說，「出力最多的是我，挨打最多的也是我。」\n「荒謬。」書生冷笑，「若無我的陣法遮掩天機，你早被轟成渣了。五五分，魔物沒腦子，給點骨頭就行。」\n「吼！」魔物不滿地咆哮，直接張嘴吞掉了那座靈石山的一半。\n\n${n}和書生同時暴怒，聯手把魔物打得滿頭包，強行讓它吐出來。三人一邊罵街，一邊斤斤計較地分配戰利品。臨別時，氣氛再次變得冰冷。\n\n「下次見面，就是證道之戰。」書生整理衣冠，恢復了冷漠，「那時，我不會留手。」\n「這話我原封不動還給你。」${n}握緊拳頭，眼中戰意燃燒，「洗乾淨脖子等著。」\n三人背對背飛向三個方向，誰都沒有回頭。但他們都知道，這諸天萬界，只有這兩個混蛋配做自己的對手。`,
        opts: [
            { t: "【暗留一手】在書生身上留下一道隱蔽的劍氣。", r: "你假裝拍肩告別，實則將一道劍意潛伏在他體內。這不是為了殺他，而是為了在關鍵時刻定位。你對這老陰比始終不放心。", s: {bne: 150000, lck: 50000}, log: (n) => `${n}與宿敵分道揚鑣前暗留後手，劍氣潛伏，為最終決戰埋下伏筆。` },
            { t: "【豪邁贈禮】扔給魔物一塊極品龍骨。", r: "「賞你的，廢物。」你看這魔物被打得太慘，隨手扔了塊骨頭。魔物愣住了，眼神複雜地看了你一眼，叼著骨頭跑了。或許它會記得這份「恩情」？", s: {cha: 100000, lck: 100000}, log: (n) => `${n}展現強者氣度，贈予魔主龍骨，無形中攻略了這頭凶獸的心。` },
            { t: "【孤獨求敗】獨自一人挑戰星球上的禁區。", r: "你沒有立刻離開，而是轉身衝進了這顆星球的絕地。你需要更強的力量，強到不需要隊友，強到能碾壓那兩個混蛋。", s: {pwr: 250000}, log: (n) => `${n}與宿敵分別後更加渴望力量，獨闖禁區磨練己身，孤狼之道貫徹到底。` }
        ]
    }
});

// 擴充寒門線 (SCHOLAR) 9-12 章
Object.assign(STORY_DB.SCHOLAR, {
    9: {
        title: "第九章：天機閣主 · 算計諸天",
        text: (n) => `百年光陰，${n}已重建天機閣，以「算盡蒼生」之名威震上界。今日，他算出「混沌源石」將在星空古路出世，這可是修復《乾坤古卷》的關鍵。\n\n然而，當他趕到時，卻看到兩個「老熟人」已經在那裡拆遷了。那個滿腦子肌肉的劍修正在用拳頭硬砸守護大陣；那個噁心的魔物正在啃食大陣的能量壁。\n\n${n}嘆了口氣，揉了揉眉心：「真是……有辱斯文。」他沒有現身，而是悄悄撥動了幾根因果線，將大陣的反擊機制稍微調整了一下——全部指向那個劍修。\n\n「轟！」一道粗大的神雷準確地劈在劍修頭頂。劍修被劈得外焦裡嫩，怒吼道：「誰？！哪個王八蛋陰我？！這味道……是那個酸秀才！」`,
        opts: [
            { t: "【現身嘲諷】優雅地走出虛空，言語羞辱。", r: "「一百年不見，你的腦子還是只有核桃大小。」你搖著羽扇，極盡嘲諷。劍修氣得哇哇叫衝過來，卻被你佈下的迷陣耍得團團轉。", s: {bne: 150000, cha: 50000}, log: (n) => `${n}重逢宿敵，以智商碾壓武夫，佈下迷陣戲耍劍修，盡顯儒雅隨和（腹黑）。` },
            { t: "【驅狼吞虎】引誘魔物去攻擊劍修。", r: "你扔出一塊沾染了龍氣的玉佩到劍修身上。魔物聞風而動，瘋狂撲向劍修。你看著兩人狗咬狗，從容收取混沌源石。", s: {lck: 150000, bne: 80000}, log: (n) => `${n}略施小計，引發魔主與武神大戰，兵不血刃奪取至寶，深諳厚黑學。` },
            { t: "【文字囚籠】試寫「困」字，同時封印兩人。", r: "你想試試現在的實力，揮筆寫下巨大的「困」字。兩人被金色牢籠罩住。雖然只困住了三息，但足夠你裝完逼就跑。", s: {pwr: 100000, bne: 120000}, log: (n) => `${n}一字鎮壓兩大天驕，雖只能困住片刻，卻足以證明儒道至聖的實力。` }
        ]
    },
    10: { // 簡化結構，對應LONE線Ch10
        title: "第十章：道統之爭 · 嘴炮無敵",
        text: (n) => `三人最終還是為了爭奪一處洞天福地打了起來。不過${n}很少親自動手，他更多的是在動口。\n\n「劍修，你的劍意雖強，但過剛易折，且看你印堂發黑，三招之內必踩狗屎。」話音剛落，劍修一腳踩進了魔物排泄的穢物中，腳下一滑，劍招全亂。\n「魔物，你雖能吞噬萬物，但這塊石頭乃是萬年玄鐵，你消化得了嗎？」魔物剛吞下一塊巨石，立刻捂著肚子滿地打滾，臉色發青。\n\n這就是${n}現在的能力——「言出法隨」。雖然還達不到修改現實的地步，但噁心人絕對是一流的。兩人被他折磨得心態崩潰，決定聯手先幹掉這個烏鴉嘴。`,
        opts: [
            { t: "【舌戰群儒】開啟嘴炮模式，同時擾亂兩人心智。", r: "你引經據典，從他們的招式破綻罵到他們的人格缺陷。兩人聽得道心不穩，差點走火入魔。這就是知識的力量！", s: {bne: 180000, cha: 80000}, log: (n) => `${n}施展絕世嘴炮，以言語動搖兩大強者道心，殺人不用刀，誅心為上。` },
            { t: "【連環陷阱】將兩人引入早已佈置好的連環殺陣。", r: "你邊退邊罵，實則將他們引入了「九曲黃河陣」。兩人一進去就被削去了頂上三花，修為大跌，嚇得轉身就跑。", s: {lck: 150000, bne: 150000}, log: (n) => `${n}步步為營，將被激怒的宿敵引入絕世殺陣，削去其修為，算無遺策。` },
            { t: "【主動求和】見好就收，提出共同開發洞天。", r: "眼看兩人真的要拼命，你立刻變臉：「二位，玩笑而已。此洞天極大，不如三人平分？」這變臉速度讓兩人措手不及。", s: {cha: 100000, lck: 120000}, log: (n) => `${n}能屈能伸，在玩火邊緣極限剎車，主動求和瓜分利益，掌控全場節奏。` }
        ]
    },
    11: { // 對應LONE線Ch11
        title: "第十一章：天罰降臨 · 算計天道",
        text: (n) => `蘇清月的追殺如期而至。這次她帶來了「諸天星斗大陣」，誓要將這三個禍害徹底抹殺。\n\n劍修和魔物已經衝上去肉搏了，打得血肉橫飛。${n}站在戰場後方，冷靜地觀察著星斗大陣的運轉軌跡。他的眼中有無數數據流在飛瀑般刷屏。\n\n「劍修，攻乾位！別管防禦，死不了！」${n}傳音入密。\n「魔物，去吞坤位的陣旗！那是大補之物！」\n\n那兩人雖然嘴上罵著「憑什麼聽你的」，但身體卻很誠實地照做了。因為他們知道，在这个戰場上，只有${n}的腦子能帶他們活著出去。隨著兩人的執行，星斗大陣出現了一絲致命的凝滯。`,
        opts: [
            { t: "【逆轉大陣】奪取星斗大陣的控制權。", r: "你燃燒十年壽元，強行將自己的神識切入大陣中樞。星光突然倒戈，轟殺了數百名天道執法者。蘇清月被氣得吐血。", s: {bne: 220000, lck: 100000}, log: (n) => `${n}以凡人之軀駭入天道大陣，奪取控制權反殺執法者，智近乎妖。` },
            { t: "【精準輔助】給劍修和魔物加持「狂暴」與「堅韌」。", r: "你在虛空寫下增益文字。劍修的攻擊力翻倍，魔物的防禦力翻倍。兩人如虎添翼，殺得興起，甚至喊你「軍師」。", s: {cha: 150000, pwr: 100000}, log: (n) => `${n}化身戰場主宰，為宿敵施加強力增益，將其化作手中利刃，橫掃千軍。` },
            { t: "【獻祭隊友】關鍵時刻賣掉劍修，換取必殺一擊。", r: "你故意報錯坐標，讓劍修承受了集火攻擊。趁著聖女露出破綻，你一筆點破了她的護體仙光。劍修重傷，但你們贏了。", s: {lck: 180000, cha: 120000}, log: (n) => `${n}心狠手辣，獻祭隊友肉身創造絕殺機會，雖贏得戰鬥但令盟友心寒。` }
        ]
    },
    12: { // 對應LONE線Ch12
        title: "第十二章：各懷鬼胎 · 頂峰再見",
        text: (n) => `戰鬥結束，三人分坐三方療傷。氣氛詭異而安靜。\n\n劍修雖然罵罵咧咧，但看${n}的眼神裡多了一絲忌憚——這書生的佈局太恐怖了。魔物則在一旁打著飽嗝，這次它吃了個爽。\n\n「此間事了，」${n}站起身，拍了拍衣袍上的灰塵，「下一次，天路盡頭，便是你我決生死之時。那時候，我不會再給你們指路了。」\n「哼，下次老子一定先把你的嘴縫上。」劍修冷哼。\n\n${n}轉身離去，背影孤傲。其實他手裡早已捏著一枚偷錄了兩人戰鬥數據的玉簡。知己知彼，百戰不殆。這場臨時的同盟，讓他收集到了足夠完善兩人「死亡模型」的數據。`,
        opts: [
            { t: "【數據推演】利用收集的數據，推演殺死兩人的方案。", r: "你邊走邊算，腦海中模擬了三千種殺死劍修和魔物的方法。你的勝率提升到了六成。這就是謀士的恐怖。", s: {bne: 250000, lck: 80000}, log: (n) => `${n}於離別之際完成對宿敵的殺局推演，勝券在握，深藏功與名。` },
            { t: "【因果綁定】悄悄將三人的氣運綁定在一起。", r: "你做了一個大膽的決定。你將三人的命運鎖死。這樣他們變強，你也變強；他們倒霉，你也倒霉。這是一場豪賭。", s: {lck: 200000, cha: 100000}, log: (n) => `${n}行逆天之舉，將自身氣運與兩大宿敵綁定，一榮俱榮一損俱損，氣魄驚人。` },
            { t: "【佈局未來】在星空古路盡頭埋下伏筆。", r: "你沒有急著提升修為，而是花費時間在必經之路上佈置了後手。當最終決戰來臨時，這一步棋將定乾坤。", s: {bne: 200000, pwr: 50000}, log: (n) => `${n}眼光長遠，提前佈局最終戰場，將未來握在手中，不爭一時之氣。` }
        ]
    }
});

// 擴充蟻民線 (BEGGAR) 9-12 章
Object.assign(STORY_DB.BEGGAR, {
    9: {
        title: "第九章：暴食回歸 · 食材升級",
        text: (n) => `一百年了，${n}吃遍了下位面的所有妖魔鬼怪，感到索然無味。直到今天，他在星空深處聞到了兩股絕世美味的氣息——是當年那塊「硬骨頭」（劍修）和那個「酸果子」（書生）！\n\n而且，經過百年的修煉，他們變得更香了！劍修身上是濃郁的血氣與不屈的意志，咬一口肯定爆漿；書生身上是清冽的法則與靈魂的香氣，吸一口絕對上頭。\n\n${n}流著哈喇子，從黑洞中鑽了出來，直接撲向了正在對峙的兩人。「開飯了！！！哥哥們，我想死你們了！」\n\n那兩人看到${n}這副尊榮，臉色瞬間發綠。劍修拔劍便砍，書生揮筆便封。${n}不躲不閃，張嘴就咬住了劍氣，順便還舔了一口書生的防禦罩。`,
        opts: [
            { t: "【強行試吃】不管攻擊，硬要在兩人身上咬一口。", r: "你拼著被砍一刀被炸一下，硬是在劍修手臂上咬了一口，又舔了書生一臉口水。雖然被打飛，但你嚐到了味道，滿足了！", s: {cha: 150000, pwr: 80000}, log: (n) => `${n}重逢宿敵，見面就是一口，以傷換吃，展現出對美食（宿敵）的極致執著。` },
            { t: "【吞噬戰場】把他們爭奪的寶物連同地皮一起吃了。", r: "「你們不給我吃，我就吃你們的鍋！」你張開深淵巨口，把方圓十里的地皮連同那件出世的寶物全吞了。兩人目瞪口呆。", s: {pwr: 120000, cha: 120000}, log: (n) => `${n}一怒之下吞噬整個戰場與寶物，讓宿敵無路可走（無寶可奪），凶威蓋世。` },
            { t: "【嘔吐攻擊】把這百年吃的垃圾吐出來噁心他們。", r: "你將體內積攢的毒素和殘渣噴向兩人。這簡直是精神汙染。那兩位愛乾淨的天驕差點當場嘔吐，戰鬥力減半。", s: {cha: 100000, lck: 80000}, log: (n) => `${n}使用生化攻擊，嘔吐毒物噁心宿敵，令其道心崩潰，戰術極其骯髒有效。` }
        ]
    },
    10: { // 對應LONE線Ch10
        title: "第十章：三方亂鬥 · 誰是食物",
        text: (n) => `混戰開始了。${n}在戰場上橫衝直撞，一會兒幫劍修撞飛書生的符文，一會兒又幫書生咬斷劍修的劍氣。他的立場只有一個：誰弱我就幫誰，讓他們打得更久一點，流更多的血，這樣我就能吃到更多的能量。\n\n「這孽畜！」書生看穿了${n}的想法，大喊道，「劍修，先停手！先把這攪屎棍弄死！」\n「正合我意！」劍修調轉劍鋒。\n\n面對兩大高手的集火，${n}不但不慌，反而興奮地全身顫抖。他身上的魔嘴一張一合，發出詭異的笑聲：「來吧……進來吧……我的肚子很大……裝得下你們全部……」`,
        opts: [
            { t: "【化身黑洞】開啟究極防禦形態，吸收所有傷害。", r: "你變成了一個完美的球體黑洞。兩人的攻擊打在你身上，九成被吸收轉化為脂肪。你以肉眼可見的速度變胖，氣息卻越來越強。", s: {pwr: 180000, cha: 150000}, log: (n) => `${n}化身無敵黑洞，硬吃兩大天驕聯手攻擊，將傷害轉化為能量，越打越肥。` },
            { t: "【魔音貫耳】用肚子發出飢餓的雷鳴聲干擾對手。", r: "你的胃部發出連鎖爆鳴，這聲音直擊靈魂，喚起生物最原始的飢餓恐懼。兩人動作一滯，被你一屁股坐飛。", s: {cha: 120000, bne: 100000}, log: (n) => `${n}以飢餓魔音撼動宿敵靈魂，趁機反殺，將猥瑣流打法發揮到極致。` },
            { t: "【分裂逃生】被打爆後化作千萬隻小魔蟲。", r: "你身體炸開，化作無數蟑螂般的小蟲四散奔逃。兩人大招落空，還被小蟲咬得渾身是包。你隨後重組，毫髮無傷。", s: {lck: 150000, cha: 100000}, log: (n) => `${n}施展不死蟲軀，化整為零戲耍強敵，生存能力諸天第一。` }
        ]
    },
    11: { // 對應LONE線Ch11
        title: "第十一章：聖餐降臨 · 天道自助",
        text: (n) => `當蘇清月帶著天道大軍降臨時，在${n}眼裡，這哪裡是圍剿，分明是送外賣！那些金光閃閃的天兵天將，在他看來就是一個個剝了殼的蝦仁；那些威嚴的法寶，就是酥脆的餅乾。\n\n「自助餐！是自助餐！」${n}流著口水衝了上去，完全無視了對方的攻擊。他一口一個天兵，嘎嘣脆。旁邊的劍修和書生都看傻了——這貨是真餓啊。\n\n蘇清月大怒，指揮大陣轟擊${n}。${n}皮糙肉厚，被打得嗷嗷叫卻死不鬆口。他轉頭對另外兩人喊道：「別愣著啊！快幫我把那隻最大的『龍蝦』（聖女法相）殼敲開！裡面的肉肯定很嫩！」`,
        opts: [
            { t: "【鯨吞天下】施展禁術，試圖吞噬整座星斗大陣。", r: "你身體膨脹到星球大小，張嘴籠罩了大陣一角。雖然嘴巴被撐裂了，但你真的吞掉了一角陣圖！大陣運轉失靈。", s: {cha: 250000, pwr: 100000}, log: (n) => `${n}顯化星球級魔軀，生吞天道大陣一角，兇殘程度刷新了諸天認知。` },
            { t: "【肉盾衝鋒】頂著火力為劍修開路。", r: "「我來扛！你去砍！」你用臉接下了所有光束，掩護劍修突進。劍修深受感動（其實是被逼的），一劍斬了敵方大將。你趁機吃了屍體。", s: {pwr: 200000, bne: 100000}, log: (n) => `${n}以臉接大招，掩護宿敵斬將，並在第一時間享用戰利品（屍體），分工明確。` },
            { t: "【污染聖光】將吃進去的魔氣反芻，污染天道靈氣。", r: "你把這裡變成了你的胃部環境。天兵們吸入魔氣紛紛墮落。蘇清月只能捏著鼻子後撤。戰場變成了你的食堂。", s: {cha: 200000, lck: 100000}, log: (n) => `${n}反芻魔氣污染戰場，逼退潔癖聖女，將神聖戰場化作私人食堂。` }
        ]
    },
    12: { // 對應LONE線Ch12
        title: "第十二章：吃飽打包 · 預約主菜",
        text: (n) => `戰鬥結束，${n}是最大的贏家。他肚子圓滾滾的，裡面裝滿了天兵天將的精華，甚至還打包了幾件法寶在胃裡慢慢消化。\n\n劍修和書生一臉嫌棄地看著他剔牙。${n}打了個飽嗝，拍了拍肚子，眼神卻變得異常清明且貪婪。他看著另外兩人，就像看著兩壇正在發酵的絕世美酒。\n\n「你們要努力變強哦……」${n}發出低沉的笑聲，嘴角裂到耳根，「現在吃你們還太早了。等到了天路盡頭，等你們成神的那一刻……那才是最美味的。」\n\n說完，他化作一團黑霧，心滿意足地滾向了宇宙深處。他決定先找個地方睡一覺，消化這頓大餐，然後準備迎接最後的盛宴。`,
        opts: [
            { t: "【進化休眠】找個恆星內部睡覺，衝擊魔神境。", r: "你鑽進一顆紅巨星，藉助恆星之火煉化體內的雜質。待你醒來，你將是真正的吞天魔神。", s: {pwr: 200000, cha: 150000}, log: (n) => `${n}以恆星為床進行究極進化，將戰場所得轉化為魔神底蘊。` },
            { t: "【種下魔念】偷偷在兩人身上留下一絲食慾魔念。", r: "這絲魔念不會傷害他們，只會讓你在他們受傷時第一時間趕到（開飯）。這是頂級獵食者的標記。", s: {lck: 150000, cha: 100000}, log: (n) => `${n}在宿敵身上種下食慾標記，將兩人視為圈養的頂級食材，耐心令人膽寒。` },
            { t: "【清理腸胃】把消化不了的雜質排泄出來，形成一顆毒星。", r: "你排出了一顆全是劇毒和怨氣的星球，這成為了後來修仙界的一大禁地。你一身輕鬆，感覺能再吃十個世界。", s: {bne: 150000, pwr: 100000}, log: (n) => `${n}排泄體內雜質創造了一方禁地，一身輕鬆，為最後的登頂做好了準備。` }
        ]
    }
});

/* ------------------------------------------------------------
   邏輯更新：處理從 Ch8 -> Ch9 的過渡以及 Ch12 -> Ch13 的過渡
   ------------------------------------------------------------ */

// 再次覆寫 handleNext，確保邏輯連貫
window.handleNext = function() {
    player.chapter++;
    
    // 如果章節 > 12，說明第三階段結束
    if (player.chapter > 12) {
        const contentDiv = document.getElementById('storyContent');
        contentDiv.innerHTML = `<div class="story-title">【第三階段 · 相愛相殺 完成】</div>
        <p>星空古路的戰鬥暫告一段落。</p>
        <p>你們三人雖已分道揚鑣，但都將前往同一個終點——諸天之巔。</p>
        <p>在那裡，你們將迎來各自故事的結局，並決定誰才是這方宇宙的唯一主宰。</p>
        <p style="color:var(--gold); font-weight:bold; font-size: 24px;">最終章節，即將到來。</p>
        <p>請等待「第四階段程式碼（13~16章）」注入以見證傳奇終局...</p>
        <p>(請在對話框中輸入「繼續」以獲取最終結局代碼)</p>`;
        
        document.getElementById('consequenceBox').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('optionList').innerHTML = '';
        
        // 更新狀態欄
        updateStatsUI();
    } else {
        renderChapter();
    }
};

// 手動檢測刷新
if(player.chapter === 9) {
    renderChapter();
} else if (player.chapter === 8 && document.getElementById('nextBtn').style.display === 'none') {
   document.getElementById('storyContent').innerHTML += `<br><br><button onclick="handleNext()" style="background:var(--crimson); color:#fff; padding:15px; border:none; cursor:pointer;">開啟第九章：相愛相殺</button>`;
}

console.log("【系統提示】第三階段數據（9~12章）已注入。高維戰場開啟。");
/* ============================================================
   【第四階段：13~16 章 · 獨斷萬古】
   包含：終極之戰、斬殺宿敵、宇宙結局、小說生成器
   ============================================================ */

// 擴充孤狼線 (LONE) 13-16 章
Object.assign(STORY_DB.LONE, {
    13: {
        title: "第十三章：登天路 · 舉世皆敵",
        text: (n) => `星空古路的盡頭，是九萬九千九百九十九級「登天台」。每一級台階都由一個毀滅的世界煉化而成。${n}獨自行走在台階上，身後是無盡的屍山血海。\n\n越往上，壓力越大。這不是重力，而是整個宇宙的因果排斥。天道不允許凡人登頂。\n\n「滾下去！」虛空中，蘇清月的本體——天道意志的化身終於顯露真容。她不再是那個清冷的聖女，而是一團由億萬光輝組成的光之巨人。她一掌拍下，掌心中蘊含著「輪迴」、「毀滅」、「時間」三大法則。\n\n${n}抬頭，渾身骨骼發出爆鳴，嘴角卻勾起一抹狂傲的笑：「老子這一生，不敬天，不禮地，只信手中一雙拳頭！你這賊老天，擋路了！」`,
        opts: [
            { t: "【以力證道】一拳轟碎法則手掌，強行登頂。", r: "你燃燒了體內所有的潛力，打出了超越物理極限的一拳。空間法則崩碎，時間長河逆流。你踏碎了蘇清月的手掌，登上了天台。", s: {pwr: 999999}, log: (n) => `${n}於登天路以力證道，一拳粉碎天道法則，踏足諸天之巔。` },
            { t: "【斬斷過往】獻祭記憶與情感，換取絕對冷靜。", r: "為了對抗天威，你斬斷了對過往的所有眷戀。你的眼神變得空洞而恐怖，天道的威壓對你再無效果。你如同一台殺戮機器登頂。", s: {bne: 999999}, log: (n) => `${n}獻祭凡人情感，化身無情修羅，無視天道威壓登頂。` },
            { t: "【燃燒神魂】以靈魂之火點燃登天台。", r: "你將自己的靈魂當作燃料。登天台被你點燃，化作助推你上位的火焰。蘇清月發出驚恐的尖叫，因為她感覺到了瘋狂。", s: {cha: 999999}, log: (n) => `${n}瘋狂燃燒神魂，將天道階梯化作自身薪柴，強勢殺入終局。` }
        ]
    },
    14: {
        title: "第十四章：弒天 · 舊時代的葬禮",
        text: (n) => `天台之巔，${n}終於站在了蘇清月本體面前。沒有廢話，沒有憐憫。\n\n「凡人，你可知殺了我，宇宙秩序將會崩潰？」蘇清月的聲音宏大而冰冷。\n「那就崩潰好了。」${n}淡淡回應，手中的斷天殘鐵此刻已化作無形的規則之刃。\n\n這是一場樸實無華的戰鬥。沒有絢麗的魔法，只有拳拳到肉的規則碰撞。每一擊都讓宇宙的一個角落熄滅。最終，${n}的手掌穿透了蘇清月的光核。天道意志發出一聲哀鳴，化作漫天光雨灑落。舊的秩序，崩塌了。\n\n但戰鬥並未結束。在光雨中，兩個熟悉的身影緩緩走出。書生手持因果律，魔物吞噬著天道碎片。他們也在這一刻，登頂了。`,
        opts: [
            { t: "【霸氣宣言】「這位置太擠，只能站我一個。」", r: "你一腳踢開蘇清月的屍體（法則碎片），目光睥睨。書生和魔物同時鎖定了你。最終決戰，一觸即發。", s: {pwr: 1000000}, log: (n) => `${n}親手終結天道時代，面對兩大宿敵，發出獨霸宣言。` },
            { t: "【主動出擊】趁兩人立足未穩，率先發難！", r: "你根本不給他們喘息的機會，直接衝向威脅最大的書生。書生倉促防禦，被你震退三步。先手優勢！", s: {bne: 1000000}, log: (n) => `${n}在斬殺天道後毫不停歇，突襲宿敵，將戰鬥節奏掌控手中。` }
        ]
    },
    15: {
        title: "第十五章：宿命終局 · 三子歸一",
        text: (n) => `這是一場注定沒有觀眾的戰鬥。${n}（力）、書生（智）、魔物（慾）。三位從微末中崛起的天命之子，在此刻展開了最後的廝殺。\n\n書生嘆息：「${n}，你太危險了，必須先除掉。」\n魔物嘶吼：「肉……最強的肉……」\n兩人竟然再次聯手！無數文字鎖鏈限制了你的行動，深淵巨口咬住了你的肩膀。\n\n${n}在劇痛中狂笑：「好！很好！這才是我期待的謝幕！」他體內的每一顆細胞都在核爆。他掙斷了鎖鏈，反手將魔物的獠牙拔下插進書生的胸膛，又用頭槌撞碎了魔物的核心。\n\n血戰三天三夜。諸天星辰盡滅。最後，只有${n}一個人搖搖晃晃地站著。腳下，是書生破碎的古卷和魔物消散的黑氣。`,
        opts: [
            { t: "【給予尊嚴】將兩人的遺物埋葬在天道之巔。", r: "「你們是值得尊敬的對手。」你沒有羞辱屍體，而是立了一座無字碑。這一刻，你感到前所未有的孤獨。", s: {cha: 1000000}, log: (n) => `${n}血戰慘勝，給予兩位宿敵最後的尊嚴，獨享無敵之寂寞。` },
            { t: "【吞噬本源】奪取他們的智慧與吞噬之力。", r: "你掠奪了書生的腦域和魔物的魔核。你集力、智、慾於一身，成為了真正的全知全能者。", s: {pwr: 1500000}, log: (n) => `${n}吞噬宿敵本源，集力、智、慾於一身，成就究極完全體。` }
        ]
    },
    16: {
        title: "第十六章：大結局 · 獨斷萬古",
        text: (n) => `虛空寂靜。${n}坐在那張原本屬於天道的王座上。下方是殘破的宇宙，上方是未知的虛空。\n\n你已經成為了唯一的「神」。你可以一念重塑世界，也可以一念毀滅所有。蘇清月死了，宿敵沒了，連過去的自己也回不來了。\n\n你握緊了拳頭，感受著體內那股足以撐爆宇宙的力量。現在，你要用這股力量，做最後一件事。`,
        opts: [
            { t: "【重塑輪迴】復活所有人，建立一個沒有天道壓迫的盛世。", r: "結局：【武神盛世】\n你消耗了九成神力，重啟了時間線。蘇清月變成了普通的賣花女，書生在私塾教書，魔物成了一隻貪吃的小狗。你在幕後默默守護這一切。這是你心中最完美的結局。", s: {bne: "MAX"}, log: (n) => `${n}耗盡神力重塑輪迴，還宇宙一個太平盛世，自身化作守護神。` },
            { t: "【破碎虛空】打穿宇宙壁壘，去往更高維度戰鬥。", r: "結局：【永恆征途】\n「這片池塘太小了。」你對無敵感到厭倦，一拳轟開了維度之門。你背起斷劍，跳入了更加兇險的未知世界。戰鬥，永無止境。", s: {pwr: "MAX"}, log: (n) => `${n}不屑止步於此，轟開維度之門，踏上更高維度的征途，留下不朽傳說。` },
            { t: "【滅世重開】毀滅這個充滿痛苦的宇宙，創造全新的法則。", r: "結局：【寂滅創世神】\n你看透了人性的醜惡。你滅絕了舊世界的一切，創造了一個只有純粹能量體的新種族。你是這個新世界的唯一主宰，永恆且孤獨。", s: {cha: "MAX"}, log: (n) => `${n}毀滅舊宇宙，創造全新法則與種族，成為絕對的創世主宰。` }
        ]
    }
});

// 擴充寒門線 (SCHOLAR) 13-16 章
Object.assign(STORY_DB.SCHOLAR, {
    13: {
        title: "第十三章：真理之門 · 解析天道",
        text: (n) => `來到登天台，${n}沒有像莽夫那樣攀爬。他推了推眼鏡，手中的《乾坤古卷》已化作一台巨大的量子解析矩陣。\n\n「所謂威壓，不過是高維信息流的沖刷。」${n}淡然說道。他每走一步，就解析掉一層天道法則。蘇清月的真身降臨，帶著毀滅的白光。\n\n「蘇清月，你的代碼……亂了。」${n}直視光之巨人，眼中閃爍著無數數據流。他看到了天道的本質——那是一段運行了億萬年的、充滿了補丁和錯誤的程序。`,
        opts: [
            { t: "【尋找BUG】攻擊天道運行的邏輯漏洞。", r: "你發現了天道在「仁愛」與「毀滅」之間的邏輯衝突。你輸入了一段悖論代碼，蘇清月的動作瞬間卡頓。趁此機會，你優雅地穿過了她的防線。", s: {bne: 999999}, log: (n) => `${n}解析天道邏輯漏洞，以悖論代碼癱瘓聖女法身，兵不血刃登頂。` },
            { t: "【覆寫權限】強行修改周圍的物理法則。", r: "「我說，此地重力為零。」你揮筆改寫規則。登天台的重力消失，你如履平地般飄向頂峰，視天威如無物。", s: {lck: 999999}, log: (n) => `${n}揮筆篡改物理法則，視天塹為通途，展現算盡諸天的恐怖。` }
        ]
    },
    // ... 為節省篇幅，寒門線後續章節邏輯相似，但結局文案不同 ...
    14: {
        title: "第十四章：格式化 · 舊神的黃昏",
        text: (n) => `蘇清月憤怒了，她調動了整個宇宙的算力試圖抹除${n}。但在${n}眼裡，這只是垂死掙扎。\n\n「你的運算速度太慢了。」${n}展開古卷，無數金色的文字化作病毒，侵入天道核心，「既然你不合格，那就讓我來重寫這個操作系統。」\n\n隨著最後一個符文落下，蘇清月的光芒黯淡。她驚恐地發現自己與宇宙的聯繫被切斷了。${n}輕輕一點，曾經高高在上的天道聖女，被分解成了最原始的靈氣粒子。`,
        opts: [
            { t: "【數據回收】將天道核心數據庫備份。", r: "你冷靜地收錄了宇宙誕生以來的所有信息。這份知識將是你成神的基石。旁邊趕來的劍修和魔物都看呆了。", s: {bne: 1000000}, log: (n) => `${n}格式化天道意志，備份宇宙全知數據，冷酷理性至極。` },
            { t: "【嘲諷全場】「這就是你們敬畏的神？不堪一擊。」", r: "你對著趕來的兩位宿敵搖了搖頭，語氣中充滿了智商上的優越感。這極大地拉高了仇恨值。", s: {cha: 1000000}, log: (n) => `${n}展現絕對智力碾壓，嘲諷舊神與宿敵，傲慢卻強大。` }
        ]
    },
    15: {
        title: "第十五章：算盡蒼生 · 智者的寂寞",
        text: (n) => `最終戰。劍修的劍很快，魔物的嘴很大。但在${n}的計算中，他們的每一個動作都有0.0001秒的破綻。\n\n「劍修，你的左肋有舊傷，這是你發力的死角。」\n「魔物，你的吞噬需要0.5秒的冷卻，這是你的命門。」\n\n${n}站在原地未動，只是不斷地撥動因果線，引導兩人互相攻擊，或者撞上他佈下的陷阱。這不是戰鬥，這是在下棋。最終，劍修力竭而亡，魔物爆體而亡。${n}合上古卷，臉上沒有喜悅，只有一種高處不勝寒的蕭索。`,
        opts: [
            { t: "【完美計算】以最小的代價全殲對手。", r: "你連衣角都沒有弄亂，就坑殺了兩位天命之子。這場戰鬥將被作為教科書載入史冊。", s: {lck: 1500000}, log: (n) => `${n}以絕對算力坑殺兩大宿敵，衣不沾血，完成智者的完美演繹。` },
            { t: "【敬一杯酒】「若無你們，這盤棋太無趣。」", r: "你憑空變出一杯酒，灑在兩人屍體前。你是孤獨的，因為世間再無能看懂你佈局的人。", s: {bne: 1200000}, log: (n) => `${n}祭奠亡故宿敵，感嘆知音難覓，體會到巔峰的絕對孤獨。` }
        ]
    },
    16: {
        title: "第十六章：大結局 · 真理之神",
        text: (n) => `${n}成為了新的「道」。宇宙在他眼中不再是物質，而是流動的數據。他坐在真理王座上，思考著宇宙的最優解。`,
        opts: [
            { t: "【機械飛升】將宇宙改造成絕對理性的機械世界。", r: "結局：【絕對秩序】\n你消除了所有的情感與混亂，將萬物數字化。沒有戰爭，沒有痛苦，只有永恆運轉的完美程序。你是這個程序的總設計師。", s: {bne: "MAX"}, log: (n) => `${n}消除情感與變數，將宇宙重塑為絕對理性的機械秩序。` },
            { t: "【教化萬界】化身萬千，在所有位面傳播知識。", r: "結局：【萬世師表】\n你放棄了絕對的統治，而是將智慧的火種灑向人間。每個人都能通過學習掌握命運。你是所有文明共同尊奉的「聖師」。", s: {cha: "MAX"}, log: (n) => `${n}散去神格，化身萬世師表，開啟全宇宙的智慧啟蒙時代。` },
            { t: "【觀測者】隱入幕後，默默記錄宇宙的生滅演變。", r: "結局：【太上忘情】\n你對干涉現實失去了興趣。你成為了一隻眼睛，靜靜地看著宇宙的生老病死，不悲不喜，永恆存在。", s: {lck: "MAX"}, log: (n) => `${n}成為超脫的觀測者，太上忘情，坐看宇宙生滅輪迴。` }
        ]
    }
});

// 擴充蟻民線 (BEGGAR) 13-16 章
Object.assign(STORY_DB.BEGGAR, {
    13: {
        title: "第十三章：饕餮盛宴 · 萬物皆可吃",
        text: (n) => `登天台？在${n}眼裡，這就是一根巨大的排骨！九萬級台階？那就是九萬塊餅乾！\n\n${n}一路走，一路吃。天道的威壓壓碎了他的骨頭，他就吃掉威壓來補鈣；規則之火燒焦了他的皮膚，他就吞掉火焰來暖胃。當他走到蘇清月面前時，身後的登天台已經被他啃缺了一半。\n\n蘇清月驚恐地看著這個怪物：「你……你是什麼東西？」\n「我……好餓……」${n}擦了擦口水，眼裡冒著綠光，「你看起來……像是香草味的冰淇淋。」`,
        opts: [
            { t: "【暴食本能】無視任何攻擊，張嘴就咬！", r: "管你是法則還是天道，進了嘴裡都是蛋白質。你一口咬在蘇清月的光翼上，撕下一大塊規則之力，嚼得津津有味。", s: {cha: 999999}, log: (n) => `${n}無視天道威嚴，將法則視為食材，一路啃食登天台至終局。` },
            { t: "【污染同化】將胃酸噴滿整個戰場。", r: "你把神聖的天台變成了你的消化道。蘇清月被你的氣息熏得戰鬥力大減。這裡是你的主場（食堂）。", s: {pwr: 999999}, log: (n) => `${n}將神聖戰場化作消化器官，污染天道領域，凶威滔天。` }
        ]
    },
    // ... 蟻民線結局邏輯 ...
    14: {
        title: "第十四章：吞天 · 最後的晚餐",
        text: (n) => `這是一場極其獵奇的戰鬥。蘇清月發出的每一道攻擊，都被${n}當作加餐吃掉了。光束？那是麵條。雷霆？那是跳跳糖。\n\n終於，蘇清月崩潰了，她的能量被吸乾，光芒黯淡。\n「多謝款待。」${n}打了個飽嗝，張開能夠吞噬星系的深淵巨口，將蘇清月連同天道核心一口吞下。\n\n隨著「咕嘟」一聲吞嚥，宇宙陷入了短暫的黑暗。${n}的肚子發出億萬雷鳴，他在進化，向著不可名狀的「古神」進化。這時，劍修和書生趕到了，他們看到的只有一個正在剔牙的恐怖怪物。`,
        opts: [
            { t: "【恐怖威懾】對著兩人流口水：「還沒吃飽...」", r: "你的眼神讓兩位天命之子都感到背脊發涼。他們意識到，眼前的東西已經超出了「生物」的範疇。", s: {cha: 1000000}, log: (n) => `${n}生吞天道聖女，進化為不可名狀之古神，視宿敵為飯後甜點。` },
            { t: "【分享食物】「那個...天道有點塞牙，你們要吃點嗎？」", r: "你吐出幾塊沒消化的法則碎片。這種神經質的舉動反而讓兩人更加忌憚。完全無法預測的瘋子。", s: {lck: 1000000}, log: (n) => `${n}神經質地邀請宿敵分享天道殘渣，瘋狂行徑令諸天膽寒。` }
        ]
    },
    15: {
        title: "第十五章：食物鏈頂端 · 終極獵食",
        text: (n) => `最後的戰鬥沒有懸念。對於一個連天道都能消化的怪物來說，劍修和書生只是兩塊比較硬的骨頭。\n\n劍氣斬開了你的肚子，你反手把劍修的劍嚼碎了；陣法困住了你的手腳，你直接把陣法所在的空間都吞了。\n\n「不打了！不打了！」書生崩潰地大喊，「這傢伙根本殺不死！」\n「晚了。」${n}微笑著（雖然這笑容裂到了後腦勺），巨大的陰影籠罩了兩人，「進來吧，我們永遠在一起……融為一體。」\n\n黑暗降臨。咀嚼聲持續了整整一個紀元。`,
        opts: [
            { t: "【細嚼慢嚥】慢慢品嚐兩位宿敵的味道。", r: "你獲得了他們的全部力量。現在，你是這個宇宙唯一的、至高無上的存在。雖然有點撐，但很滿足。", s: {pwr: 1500000}, log: (n) => `${n}將兩大宿敵細細咀嚼吞噬，登頂食物鏈盡頭，成就唯一真魔。` }
        ]
    },
    16: {
        title: "第十六章：大結局 · 虛空巨獸",
        text: (n) => `宇宙已經空了。能吃的都吃了，不能吃的也被你消化了。${n}漂浮在死寂的虛空中，感到一種前所未有的飢餓。\n\n這就是無敵的代價嗎？永遠填不滿的胃。`,
        opts: [
            { t: "【沉睡孵化】化作宇宙本身，等待新的生命誕生。", r: "結局：【萬物之母/父】\n你將身體化作大地和星辰，將吞噬的能量反哺出來。你的身體孕育了新的宇宙。你既是毀滅者，也是創造者。", s: {bne: "MAX"}, log: (n) => `${n}身化宇宙，反哺萬物，成為新紀元的混沌母體，循環不息。` },
            { t: "【吞噬維度】吃穿宇宙壁壘，去吃別的宇宙。", r: "結局：【諸天蝗蟲】\n「這裡沒吃的了，去下一家。」你啃穿了維度膜，帶著無盡的貪婪爬向了平行宇宙。你是所有位面的噩夢。", s: {cha: "MAX"}, log: (n) => `${n}啃穿維度壁壘，化身諸天蝗蟲，開始了吞噬多元宇宙的無限恐怖。` },
            { t: "【自我吞噬】既然無物可吃，那就吃自己。", r: "結局：【歸零者】\n你從尾巴開始吃自己。隨著你的吞噬，宇宙開始坍縮，最終回歸為一個奇點。一切歸零，等待下一次大爆炸。", s: {pwr: "MAX"}, log: (n) => `${n}吞噬自身，令宇宙坍縮歸零，重啟混沌，完成終極循環。` }
        ]
    }
});

/* ------------------------------------------------------------
   新增功能：小說生成器
   ------------------------------------------------------------ */

// 生成並下載小說的函數
window.generateNovel = function() {
    let novelText = `《諸天爭霸：${player.name}傳奇》\n`;
    novelText += `作者：Gemini AI & 玩家\n`;
    novelText += `生成時間：${new Date().toLocaleString()}\n`;
    novelText += `最終屬性：體魄[${player.stats.pwr}] 根骨[${player.stats.bne}] 氣運[${player.stats.lck}] 魅力[${player.stats.cha}]\n`;
    novelText += `------------------------------------------------\n\n`;

    // 這裡我們簡單地根據玩家的進度和日誌重構故事
    // 由於我們在 log 中存儲了簡短的摘要，我們將使用這些摘要
    
    if (player.logs && player.logs.length > 0) {
        player.logs.forEach((entry, index) => {
            novelText += `【第 ${index + 1} 章】\n`;
            novelText += `${entry}\n\n`;
        });
    } else {
        novelText += "（系統未能檢測到詳細日誌，僅生成結局摘要）\n";
    }

    novelText += `------------------------------------------------\n`;
    novelText += `【全書完】\n`;
    novelText += `感謝您的遊玩！`;

    // 創建 Blob 並下載
    const blob = new Blob([novelText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${player.name}_諸天傳奇.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
};


/* ------------------------------------------------------------
   邏輯更新：處理結局與小說生成
   ------------------------------------------------------------ */

window.handleNext = function() {
    // 如果已經在最後一章（16章），再點擊則視為結束
    if (player.chapter >= 16) {
        const contentDiv = document.getElementById('storyContent');
        
        // 獲取最後的結局描述（基於最後一次選擇）
        // 這裡做一個簡單的處理，顯示通關畫面
        
        contentDiv.innerHTML = `<div class="story-title" style="color:var(--gold)">【傳說終結】</div>
        <p>你的故事已化作諸天萬界不可磨滅的傳說。</p>
        <p>無論是成為守護神、大魔頭還是真理本身，你都已登頂。</p>
        <br>
        <p style="text-align:center; font-size:20px;">🎉 恭喜通關 🎉</p>
        <br>
        <div style="display:flex; flex-direction:column; gap:10px;">
                        <button onclick="location.reload()" style="background:#555; color:#fff; padding:15px; border:none; cursor:pointer;">🔄 重新開始輪迴</button>
        </div>`;
        
        document.getElementById('consequenceBox').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('optionList').innerHTML = '';
        updateStatsUI();
        return;
    }

    player.chapter++;
    renderChapter();
};

// 確保按鈕顯示
if(player.chapter === 13) {
    renderChapter();
} else if (player.chapter === 12 && document.getElementById('nextBtn').style.display === 'none') {
    document.getElementById('storyContent').innerHTML += `<br><br><button onclick="handleNext()" style="background:var(--crimson); color:#fff; padding:15px; border:none; cursor:pointer;">開啟終章：獨斷萬古</button>`;
}

console.log("【系統提示】最終階段數據（13~16章）已注入。小說生成器已就緒。祝您登頂愉快！");
</script>
</body>
</html>
